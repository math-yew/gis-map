"use strict";(self.webpackChunkarcgis=self.webpackChunkarcgis||[]).push([[5696],{7848:(pe,$,l)=>{l.d($,{G6:()=>ge,Ie:()=>Ee,J9:()=>re,RF:()=>k,U1:()=>de,vY:()=>O,ym:()=>K});var u=l(62208),p=l(91179);const g=(a,o,d)=>[o,d],E=(a,o,d)=>[o,d,a[2]],I=(a,o,d)=>[o,d,a[2],a[3]];function O(a){return a?{originPosition:"upper-left"===a.originPosition?"upperLeft":"lower-left"===a.originPosition?"lowerLeft":a.originPosition,scale:a.tolerance?[a.tolerance,a.tolerance]:[1,1],translate:(0,u.pC)(a.extent)?[a.extent.xmin,a.extent.ymax]:[0,0]}:null}function S({scale:a,translate:o},d){return Math.round((d-o[0])/a[0])}function W({scale:a,translate:o},d){return Math.round((o[1]-d)/a[1])}function D(a,o,d){const y=[];let m,F,U,A;for(let M=0;M<d.length;M++){const H=d[M];M>0?(U=S(a,H[0]),A=W(a,H[1]),U===m&&A===F||(y.push(o(H,U-m,A-F)),m=U,F=A)):(m=S(a,H[0]),F=W(a,H[1]),y.push(o(H,m,F)))}return y.length>0?y:null}function h({scale:a,translate:o},d){return d*a[0]+o[0]}function b({scale:a,translate:o},d){return o[1]-d*a[1]}function L(a,o,d){const y=new Array(d.length);if(!d.length)return y;const[m,F]=a.scale;let U=h(a,d[0][0]),A=b(a,d[0][1]);y[0]=o(d[0],U,A);for(let M=1;M<d.length;M++){const H=d[M];U+=H[0]*m,A-=H[1]*F,y[M]=o(H,U,A)}return y}function ae(a,o,d){const y=new Array(d.length);for(let m=0;m<d.length;m++)y[m]=L(a,o,d[m]);return y}function k(a,o,d,y,m){return o.x=S(a,d.x),o.y=W(a,d.y),o!==d&&(y&&(o.z=d.z),m&&(o.m=d.m)),o}function K(a,o){return a&&o?(0,p.wp)(o)?k(a,{},o,!1,!1):(0,p.l9)(o)?function Z(a,o,d,y,m){const F=function P(a,o,d,y){const m=[],F=d?y?I:E:y?E:g;for(let U=0;U<o.length;U++){const A=D(a,F,o[U]);A&&A.length>=2&&m.push(A)}return m.length?m:null}(a,d.paths,y,m);return F?(o.paths=F,o):null}(a,{},o,!1,!1):(0,p.oU)(o)?function q(a,o,d,y,m){const F=function Y(a,o,d,y){const m=[],F=d?y?I:E:y?E:g;for(let U=0;U<o.length;U++){const A=D(a,F,o[U]);A&&A.length>=3&&m.push(A)}return m.length?m:null}(a,d.rings,y,m);return F?(o.rings=F,o):null}(a,{},o,!1,!1):(0,p.aW)(o)?function oe(a,o,d,y,m){return o.points=function x(a,o,d,y){return D(a,d?y?I:E:y?E:g,o)}(a,d.points,y,m)??[],o}(a,{},o,!1,!1):(0,p.YX)(o)?function ue(a,o,d,y,m){return o.xmin=S(a,d.xmin),o.ymin=W(a,d.ymin),o.xmax=S(a,d.xmax),o.ymax=W(a,d.ymax),o!==d&&(y&&(o.zmin=d.zmin,o.zmax=d.zmax),m&&(o.mmin=d.mmin,o.mmax=d.mmax)),o}(a,{},o,!1,!1):null:null}function re(a,o,d,y,m){return(0,u.pC)(d)&&(o.points=function j(a,o,d,y){return L(a,d?y?I:E:y?E:g,o)}(a,d.points,y,m)),o}function de(a,o,d,y,m){return(0,u.Wi)(d)||(o.x=h(a,d.x),o.y=b(a,d.y),o!==d&&(y&&(o.z=d.z),m&&(o.m=d.m))),o}function Ee(a,o,d,y,m){return(0,u.pC)(d)&&(o.rings=function ie(a,o,d,y){return ae(a,d?y?I:E:y?E:g,o)}(a,d.rings,y,m)),o}function ge(a,o,d,y,m){return(0,u.pC)(d)&&(o.paths=function fe(a,o,d,y){return ae(a,d?y?I:E:y?E:g,o)}(a,d.paths,y,m)),o}},82230:(pe,$,l)=>{l.r($),l.d($,{default:()=>Le});var u=l(15861),p=l(17626),G=l(88879),g=l(77712),O=(l(90912),l(85931),l(76898));let J=class extends G.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer&&this.sourceLayer.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};(0,p._)([(0,g.Cb)({type:Boolean})],J.prototype,"isAggregate",void 0),J=(0,p._)([(0,O.j)("esri.AggregateGraphic")],J);const S=J;l(29132);var D=l(74333),z=l(26584),x=l(8314),Y=l(58817),P=l(63290),h=l(62208),b=l(10699),L=l(32917),ae=l(14517),ye=l(52884);let j=class extends ae.Z{constructor(e){super(e),this._filter=null,this.duration=(0,x.Z)("mapview-transitions-duration"),this._excludedEffectView=new ye.AM(e),this._includedEffectView=new ye.AM(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){return this._filter||(0,h.Wg)(this.featureEffect)?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),r=(0,h.Wg)(e),i=(0,h.Wg)(r?.includedEffect),s=(0,h.Wg)(r?.excludedEffect),c=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=i,this._excludedEffectView.effect=s,this._set("featureEffect",r),this._filter=r?.filter||t?.filter||null,c||this.endTransitions()}};(0,p._)([(0,g.Cb)()],j.prototype,"_filter",void 0),(0,p._)([(0,g.Cb)()],j.prototype,"_excludedEffectView",void 0),(0,p._)([(0,g.Cb)()],j.prototype,"_includedEffectView",void 0),(0,p._)([(0,g.Cb)()],j.prototype,"duration",void 0),(0,p._)([(0,g.Cb)()],j.prototype,"excludedEffects",null),(0,p._)([(0,g.Cb)()],j.prototype,"featureEffect",null),(0,p._)([(0,g.Cb)()],j.prototype,"filter",null),(0,p._)([(0,g.Cb)()],j.prototype,"hasEffects",null),(0,p._)([(0,g.Cb)()],j.prototype,"includedEffects",null),(0,p._)([(0,g.Cb)({value:0})],j.prototype,"scale",null),(0,p._)([(0,g.Cb)()],j.prototype,"transitioning",null),j=(0,p._)([(0,O.j)("esri.layers.effects.FeatureEffectView")],j);const fe=j;var ie=l(98624),se=l(72469),te=l(68653),ce=l(17253),le=l(65234);let ne=class extends ce.Z{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){const r=le.Z.fromJSON(t.spatialReference),i=[];for(let s=0;s<e.length;s++){const c=e[s],f=S.fromJSON(c),R=c.geometry&&c.geometry.spatialReference;(0,h.pC)(f.geometry)&&!R&&(f.geometry.spatialReference=r);const v=c.aggregateGeometries,_=f.aggregateGeometries;if(v&&(0,h.pC)(_))for(const C in _){const w=_[C],N=v[C]?.spatialReference;(0,h.pC)(w)&&!N&&(w.spatialReference=r)}i.push(f)}return i}};(0,p._)([(0,g.Cb)({type:[S],json:{write:!0}})],ne.prototype,"features",void 0),(0,p._)([(0,te.r)("features")],ne.prototype,"readFeatures",null),ne=(0,p._)([(0,O.j)("esri.rest.support.AggregateFeatureSet")],ne);const ue=ne;var oe=l(96854),k=l(39351),q=l(37384),Z=l(49391);function T(){return(T=(0,u.Z)(function*(e,t){if(!e)return null;switch(e.type){case"symbol":return new((yield Promise.all([l.e(5314),l.e(5506),l.e(9202),l.e(4589),l.e(8592),l.e(8803)]).then(l.bind(l,58803))).default)(t);case"heatmap":return new((yield Promise.all([l.e(5314),l.e(5506),l.e(9202),l.e(4589),l.e(8592),l.e(2900)]).then(l.bind(l,32900))).default)(t)}})).apply(this,arguments)}var re=l(22418),de=l(62192),Ee=l(71251);function ge(e){return e.some(t=>t.globalId)}function a(e){return e.filter(t=>!t.error).map(t=>t.objectId??t.globalId).filter(t=>null!=t)}function o(e,t){const r=new Set(e);for(const i of t.values())r.add(i);return r}function d(e,t){const r=new Set(e);for(const i of t.values())r.delete(i);return r}let y=class extends ae.Z{constructor(e){super(e),this._hasGlobalIds=!1,this._notifyUpdating=()=>{this.notifyChange("updating")}}normalizeCtorArgs(e){return this._queueProcessor=new Ee.e({concurrency:1,process:e.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(e){const t=this._queueProcessor,r=t.last();switch(e.type){case"update":case"refresh":if(r?.type===e.type)return;t.push(e).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{const i="processed-edit"===r?.type?r:null;i&&t.popLast();const s=this._mergeEdits(i,e);for(const c of s)c&&t.push(c).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")}_mergeEdits(e,t){const{addedFeatures:r,deletedFeatures:i,updatedFeatures:s}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||ge(r)||ge(s)||ge(i),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...r,...s],removed:i}}];const c=new Set(a(e?.edits.addOrModified??[])),f=new Set(a(e?.edits.removed??[])),R=new Set([...a(r),...a(s)]),v=new Set(a(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(o(d(c,v),R)).map(_=>({objectId:_})),removed:Array.from(o(d(f,R),v)).map(_=>({objectId:_}))}}]}};(0,p._)([(0,g.Cb)({readOnly:!0})],y.prototype,"updating",null),(0,p._)([(0,g.Cb)()],y.prototype,"process",void 0),y=(0,p._)([(0,O.j)("esri.views.2d.layers.support.FeatureCommandQueue")],y);const m=y;var F=l(60330),U=l(59289);let M=class extends F.D{constructor(e){super(e),this._startupResolver=(0,b.hh)(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(e){this.client.tileRenderer=e}get closed(){return this._connection.closed}startup(e,t,r,i){var s=this;return(0,u.Z)(function*(){yield s.when();const c=s._controller.signal,f=function A(e){return Array.isArray(e)}(r.source)?{transferList:r.source,signal:c}:void 0,R={service:r,config:t,tileInfo:e.tileInfo.toJSON(),tiles:i};yield s._connection.invoke("startup",R,f),s._startupResolver.resolve(),s._set("isReady",!0)})()}updateTiles(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,b.R8)(t._connection.invoke("updateTiles",e))})()}update(e){var t=this;return(0,u.Z)(function*(){const r={config:e};return yield t._startupResolver.promise,t._connection.invoke("update",r)})()}applyUpdate(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("applyUpdate",e)})()}setHighlight(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,b.R8)(t._connection.invoke("controller.setHighlight",e))})()}stop(){var e=this;return(0,u.Z)(function*(){if(yield e._startupResolver.promise,!e.closed)return(0,b.R8)(e._connection.invoke("stop"))})()}refresh(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,b.R8)(t._connection.invoke("controller.refresh",e))})()}querySummaryStatistics(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.querySummaryStatistics",{query:e.toJSON(),params:t},r)})()}queryAggregateSummaryStatistics(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateSummaryStatistics",{query:e.toJSON(),params:t},r)})()}queryUniqueValues(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryUniqueValues",{query:e.toJSON(),params:t},r)})()}queryAggregateUniqueValues(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateUniqueValues",{query:e.toJSON(),params:t},r)})()}queryClassBreaks(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryClassBreaks",{query:e.toJSON(),params:t},r)})()}queryAggregateClassBreaks(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateClassBreaks",{query:e.toJSON(),params:t},r)})()}queryHistogram(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryHistogram",{query:e.toJSON(),params:t},r)})()}queryAggregateHistogram(e,t,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateHistogram",{query:e.toJSON(),params:t},r)})()}queryFeatures(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatures",e?.toJSON(),t)})()}queryVisibleFeatures(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryVisibleFeatures",e?.toJSON(),t)})()}queryObjectIds(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryObjectIds",e?.toJSON(),t)})()}queryFeatureCount(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatureCount",e?.toJSON(),t)})()}queryExtent(e,t){var r=this;return(0,u.Z)(function*(){return r._connection.invoke("controller.queryExtent",e.toJSON(),t)})()}queryLatestObservations(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryLatestObservations",e.toJSON(),t)})()}queryStatistics(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.queryStatistics",e)})()}queryAggregates(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregates",e?.toJSON(),t)})()}queryAggregateCount(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateCount",e?.toJSON(),t)})()}queryAggregateIds(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateIds",e?.toJSON(),t)})()}getObjectId(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getObjectId",e)})()}getDisplayId(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getDisplayId",e)})()}getFeatures(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getFeatures",e)})()}getAggregates(){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getAggregates")})()}getAggregateValueRanges(){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getAggregateValueRanges")})()}mapValidDisplayIds(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.mapValidDisplayIds",e)})()}onEdits(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,b.R8)(t._connection.invoke("controller.onEdits",e))})()}enableEvent(e,t){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,(0,b.R8)(r._connection.invoke("controller.enableEvent",{name:e,value:t}))})()}pauseStream(){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,b.R8)(e._connection.invoke("controller.pauseStream"))})()}resumeStream(){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,b.R8)(e._connection.invoke("controller.resumeStream"))})()}sendMessageToSocket(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,b.R8)(t._connection.invoke("controller.sendMessageToSocket",e))})()}sendMessageToClient(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,b.R8)(t._connection.invoke("controller.sendMessageToClient",e))})()}updateCustomParameters(e){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,b.R8)(t._connection.invoke("controller.updateCustomParameters",e))})()}_startWorker(e){var t=this;return(0,u.Z)(function*(){try{t._connection=yield(0,U.bA)("Pipeline",{client:t.client,strategy:"dedicated",signal:e})}catch(r){(0,b.H9)(r)}})()}};(0,p._)([(0,g.Cb)()],M.prototype,"isReady",void 0),(0,p._)([(0,g.Cb)({constructOnly:!0})],M.prototype,"client",void 0),(0,p._)([(0,g.Cb)()],M.prototype,"tileRenderer",null),M=(0,p._)([(0,O.j)("esri.views.2d.layers.support.FeatureLayerProxy")],M);const H=M;var me=l(43930),ve=l(84378),xe=l(58098);class Pe{constructor(t){this._tiles=new Map,this.buffer=0,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this.buffer=t.buffer}destroy(){}clear(){this._tiles.forEach(t=>this._releaseTile(t))}tileKeys(){const t=[];return this._tiles.forEach((r,i)=>t.push(i)),t}update(t){const r=this.tileInfoView.getTileCoverage(t.state,this.buffer,"closest"),{spans:i,lodInfo:s}=r,{level:c}=s,f=[],R=[],v=new Set,_=new Set;for(const{row:C,colFrom:w,colTo:N}of i)for(let V=w;V<=N;V++){const X=xe.Z.getId(c,C,s.normalizeCol(V),s.getWorldForColumn(V)),ee=this._getOrAcquireTile(f,X);v.add(X),ee.isReady?ee.visible=!0:_.add(ee.key)}return _.forEach(C=>this._addPlaceholders(v,C)),this._tiles.forEach(C=>{v.has(C.key.id)||(R.push(C.key.id),this._releaseTile(C))}),ve.Z.pool.release(r),{hasMissingTiles:_.size>0,added:f,removed:R}}_getOrAcquireTile(t,r){if(!this._tiles.has(r)){const i=this.acquireTile(new xe.Z(r));t.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(t){return this._tiles.get(t)}_releaseTile(t){this._tiles.delete(t.key.id),this.releaseTile(t)}_addPlaceholders(t,r){const i=this._addPlaceholderChildren(t,r);Math.abs(1-i)<1e-6||this._addPlaceholderParent(t,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(t,r){let i=0;return this._tiles.forEach(s=>{i+=this._addPlaceholderChild(t,s,r)}),i}_addPlaceholderChild(t,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,t.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(t,r){let i=r.getParentKey(),s=0,c=null;for(;(0,h.pC)(i);){if(t.has(i.id))return!0;const f=this._getTile(i.id);if(f?.isReady){for(const R of t){const v=this._getTile(R);v&&i.contains(v.key)&&(v.visible=!1)}return f.visible=!0,t.add(f.key.id),!0}f?.hasData&&f.patchCount>s&&(s=f.patchCount,c=f),i=i.getParentKey()}return!!c&&(c.visible=!0,t.add(c.key.id),!0)}}var Te=l(13812),Ue=l(2319),B=l(36630),Se=l(59990),Ae=l(46679),_e=l(10023);const Ie="esri.views.layers.FeatureLayerView",be=P.Z.getLogger(Ie),we=e=>{let t=class extends e{constructor(...r){super(...r),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([(0,L.YP)(()=>{const r=this.layer;return[r?.elevationInfo?.featureExpressionInfo,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),L.tX),(0,L.on)(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),(0,L.on)(()=>{const r=this.layer;return r&&"sublayers"in r?r.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:r,layer:{fieldsIndex:i},requiredFields:s}=this;return(0,B.Q0)(i,"outFields"in r&&r.outFields?[...(0,B.Lk)(i,r.outFields),...s]:s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){be.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(r){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=(0,h.pC)(this.filter)?this.filter.createQuery(r):new oe.Z(r);if("feature"===this.layer.type){const s=(0,Se.c)(this);(0,h.pC)(s)&&(i.where=i.where?`(${i.where}) AND (${s})`:s)}return(0,h.pC)(this.timeExtent)&&(i.timeExtent=(0,h.pC)(i.timeExtent)?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}createAggregateQuery(){return new oe.Z({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}fetchPopupFeatures(r,i){var s=this;return(0,u.Z)(function*(){const c=s.validateFetchPopupFeatures(i);if(c)throw c;return s.fetchClientPopupFeatures(i)})()}_loadArcadeModules(r){return r.get("expressionInfos.length")||Array.isArray(r.content)&&r.content.some(i=>"expression"===i.type)?(0,Ae.LC)():Promise.resolve()}_handleRequiredFieldsChange(){const r=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",r),r.then(()=>{this._updatingRequiredFieldsPromise===r&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var r=this;return(0,u.Z)(function*(){if(!r.layer||!r.view)return;const i="3d"===r.view.type,{layer:s,layer:{fieldsIndex:c,objectIdField:f}}=r,R="renderer"in s&&s.renderer,v="orderBy"in s&&s.orderBy,_="featureReduction"in s?s.featureReduction:null,C=new Set,w=yield(0,b.as)([R?R.collectRequiredFields(C,c):null,(0,B.Mu)(C,s),i?(0,B.vl)(C,s):null,(0,h.pC)(r.filter)?(0,B.Ll)(C,s,r.filter):null,(0,h.pC)(r.featureEffect)?(0,B.Ll)(C,s,r.featureEffect.filter):null,_?(0,B.ZV)(C,s,_):null,v?(0,B.Qj)(C,s,v):null]);if("timeInfo"in s&&s.timeInfo&&r.timeExtent&&(0,B.gd)(C,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"feature"===s.type&&(s.floorInfo&&(0,B.gd)(C,s.fieldsIndex,[s.floorInfo.floorField]),i&&(0,h.pC)(s.infoFor3D)&&(null==s.globalIdField&&be.error("globalIdField missing on 3DObjectFeatureLayer"),(0,B.gd)(C,s.fieldsIndex,[s.globalIdField]))),"subtype-group"===s.type){(0,B.AB)(C,c,s.subtypeField);const V=s.sublayers.map(X=>Promise.all([X.renderer?.collectRequiredFields(C,c),(0,B.Mu)(C,X)]));yield(0,b.as)(V)}for(const V of w)V.error&&be.error(V.error);(0,B.AB)(C,c,f),i&&"displayField"in s&&s.displayField&&(0,B.AB)(C,c,s.displayField);const N=Array.from(C).sort();r._set("requiredFields",N)})()}validateFetchPopupFeatures(r){if((0,h.Wi)(r))return null;for(const i of r.clientGraphics??[]){const s=i.layer;if("popupEnabled"in s&&!s.popupEnabled)return new z.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){const c="featureReduction"in s?s.featureReduction:null;if(!(c&&"popupTemplate"in c&&c.popupEnabled&&c.popupTemplate))return new z.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!(0,_e.V)(s,r))return new z.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}fetchClientPopupFeatures(r){var i=this;return(0,u.Z)(function*(){const s=(0,h.pC)(r)?r.clientGraphics:null;if(!s||0===s.length)return[];const c=new Array(s.length),f=new Map,R=yield i.createPopupQuery(r);for(let v=0;v<s.length;v++){const _=s[v];if(_.isAggregate){c[v]=_;continue}const C=_.layer;if(!("popupEnabled"in C))continue;const w=(0,B.Lk)(i.layer.fieldsIndex,R.outFields),N=(0,_e.V)(C,r);if((0,h.Wi)(N))continue;const V=yield i._loadArcadeModules(N);V&&V.arcadeUtils.hasGeometryOperations(N)||!(0,B.R9)(w,_)?f.set(_.getObjectId(),{graphic:_,index:v}):c[v]=_}if("stream"===i.layer.type||0===f.size)return c.filter(Boolean);R.objectIds=Array.from(f.keys());try{const v=yield i.layer.queryFeatures(R);for(const _ of v.features){const{graphic:{geometry:C},index:w}=f.get(_.getObjectId());_.geometry||(_.geometry=C),c[w]=_}}catch{}return c.filter(Boolean)})()}createPopupQuery(r){var i=this;return(0,u.Z)(function*(){const s=i.layer.createQuery(),c=new Set;let f=!1;const R=(0,h.pC)(r)&&r.clientGraphics?r.clientGraphics.map(v=>v.layer):[i.layer];for(const v of R){if(!("popupEnabled"in v))continue;const _=(0,_e.V)(v,r);if((0,h.Wi)(_))continue;const C=yield i._loadArcadeModules(_),w=C&&C.arcadeUtils.hasGeometryOperations(_);f=!("point"!==i.layer.geometryType&&!w);const N=yield(0,_e.e)(i.layer,_);for(const V of N)c.add(V)}if(s.returnGeometry=f,s.returnZ=f,s.returnM=f,s.outFields=Array.from(c),s.outSpatialReference=i.view.spatialReference,"feature"===i.layer.type){const v=(0,Se.c)(i);(0,h.pC)(v)&&(s.where=s.where?`(${s.where}) AND (${v})`:v)}return s})()}canResume(){return!(!super.canResume()||(0,h.pC)(this.timeExtent)&&this.timeExtent.isEmpty)}};return(0,p._)([(0,g.Cb)()],t.prototype,"_updatingRequiredFieldsPromise",void 0),(0,p._)([(0,g.Cb)({readOnly:!0})],t.prototype,"availableFields",null),(0,p._)([(0,g.Cb)({type:Ue.Z})],t.prototype,"featureEffect",null),(0,p._)([(0,g.Cb)({type:ie.Z})],t.prototype,"filter",void 0),(0,p._)([(0,g.Cb)(Te.qG)],t.prototype,"timeExtent",void 0),(0,p._)([(0,g.Cb)()],t.prototype,"layer",void 0),(0,p._)([(0,g.Cb)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),(0,p._)([(0,g.Cb)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),(0,p._)([(0,g.Cb)({readOnly:!0})],t.prototype,"requiredFields",void 0),(0,p._)([(0,g.Cb)()],t.prototype,"suspended",void 0),(0,p._)([(0,g.Cb)()],t.prototype,"view",void 0),t=(0,p._)([(0,O.j)(Ie)],t),t};var Ze=l(45611),Ve=l(94421),Me=l(31637),Ne=l(2004);function Oe(e){return e&&"openPorts"in e}let Q=class extends(we((0,Ve.Z)((0,q.y)(Ze.Z)))){constructor(){var e;super(...arguments),e=this,this._pipelineIsUpdating=!0,this._commandsQueue=new m({process:t=>{switch(t.type){case"processed-edit":return this._doEdit(t);case"refresh":return this._doRefresh(t.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=(0,b.Ds)((0,u.Z)(function*(){return e._proxy.setHighlight(Array.from(e._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new fe,this._lastDefinitionExpression=null}destroy(){(0,h.yw)(this._updateClusterSizeTask,e=>e.remove()),this._proxy?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.addHandles([this.on("valueRangesChanged",e=>{this._set("_aggregateValueRanges",e.valueRanges)}),(0,L.YP)(()=>this.featureEffect,e=>{this.featureEffectView.featureEffect=e},L.tX)],"constructor"),this.featureEffectView.endTransitions()}_initProxy(){var e=this;return(0,u.Z)(function*(){const t=e.layer;if("isTable"in t&&t.isTable)throw new z.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e.layer});if(("feature"===t.type||"subtype-group"===t.type)&&!(0,se.S1)(t)?.operations.supportsQuery)throw new z.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:t});e._proxy&&e._proxy.destroy();const r=e._createClientOptions();return e._set("_proxy",new H({client:r})),e._proxy.when()})()}_initServiceOptions(){var e=this;return(0,u.Z)(function*(){return e._set("_serviceOptions",yield e._createServiceOptions()),e._serviceOptions})()}get _effectiveFeatureReduction(){if(!("featureReduction"in this.layer))return null;const e=this.layer.featureReduction;return e&&(!("maxScale"in e)||!e.maxScale||e.maxScale<this.view.scale)?e:null}get orderByFields(){return"stream"!==this._serviceOptions?.type?this._serviceOptions?.orderByFields:void 0}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some(t=>t.labelingInfo&&t.labelsVisible)}get queryMode(){return this._serviceOptions?.type}get renderingConfigHash(){if(!this.layer)return null;const e=this.availableFields,t=this.layer,r=this.view.floors,{definitionExpression:i}=t,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,c="renderer"in t&&t.renderer,f="gdbVersion"in t?t.gdbVersion:void 0,R="historicMoment"in t?t.historicMoment?.getTime():void 0,{timeExtent:v}=this,_="customParameters"in t?JSON.stringify(t.customParameters):void 0,C="apiKey"in t?t.apiKey:void 0,w="stream"===t.type?`${JSON.stringify(t.geometryDefinition)}${t.definitionExpression}`:null,N=JSON.stringify(this.clips),V=this._effectiveFeatureReduction?.toJSON(),X="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),ee="sublayers"in this.layer&&this.layer.sublayers.items.reduce((he,Re)=>he+`${Re.visible?1:0}.${JSON.stringify(Re.renderer)}.${Re.labelsVisible}\n.${JSON.stringify(Re.labelingInfo)}`,"");return JSON.stringify({orderBy:X,sublayerHash:ee,subtypeCode:"subtypeCode"in this.layer&&this.layer.subtypeCode,filterHash:(0,h.pC)(this.filter)&&this.filter.toJSON(),effectHash:(0,h.pC)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:w,gdbVersion:f,definitionExpression:i,historicMoment:R,availableFields:e,renderer:c,labelingInfo:s,timeExtent:v,floors:r,clipsHash:N,featureReduction:V,customParameters:_,apiKey:C})}highlight(e){let t;e instanceof G.Z?t=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?t=[e]:D.Z.isCollection(e)&&e.length>0?t=e.map(i=>i?.getObjectId()).toArray():Array.isArray(e)&&e.length>0&&(t="number"==typeof e[0]||"string"==typeof e[0]?e:e.map(i=>i?.getObjectId()));const r=t?.filter(h.pC);return r&&r.length?(this._addHighlight(r),{remove:()=>this._removeHighlight(r)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(e,t){var r=this;return(0,u.Z)(function*(){if(!r.tileRenderer)return null;const i=yield r.tileRenderer.hitTest(t);if(0===i.length)return null;const{features:s,aggregates:c}=yield r._proxy.getFeatures(i);return[...c.map(f=>r._createGraphicHit(e,S.fromJSON(f))),...s.map(f=>r._createGraphicHit(e,G.Z.fromJSON(f)))]})()}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.querySummaryStatistics(i._cleanUpQuery(e),s,r)})()}queryAggregateSummaryStatistics(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateSummaryStatistics(i._cleanUpAggregateQuery(e),s,r)})()}queryUniqueValues(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryUniqueValues(i._cleanUpQuery(e),s,r)})()}queryAggregateUniqueValues(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateUniqueValues(i._cleanUpAggregateQuery(e),s,r)})()}queryClassBreaks(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryClassBreaks(i._cleanUpQuery(e),s,r)})()}queryAggregateClassBreaks(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateClassBreaks(i._cleanUpAggregateQuery(e),s,r)})()}queryHistogram(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryHistogram(i._cleanUpQuery(e),s,r)})()}queryAggregateHistogram(e,t,r){var i=this;return(0,u.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateHistogram(i._cleanUpAggregateQuery(e),s,r)})()}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then(r=>{const i=ce.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryVisibleFeatures(e,t){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(e),t).then(r=>{const i=ce.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryAggregates(e,t){var r=this;return(0,u.Z)(function*(){const i=yield r._proxy.queryAggregates(r._cleanUpAggregateQuery(e),t),s=ue.fromJSON(i);return s.features.forEach(c=>r._setLayersForFeature(c)),s})()}queryAggregateIds(e,t){return this._proxy.queryAggregateIds(this._cleanUpAggregateQuery(e),t)}queryAggregateCount(e,t){return this._proxy.queryAggregateCount(this._cleanUpAggregateQuery(e),t)}queryAggregateJSON(e,t){return this._proxy.queryAggregates(this._cleanUpAggregateQuery(e),t)}queryFeaturesJSON(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}queryObjectIds(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}queryFeatureCount(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}queryExtent(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then(r=>({count:r.count,extent:Ne.Z.fromJSON(r.extent)}))}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:t,added:r,removed:i}=this._tileStrategy.update(e);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),t&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new Pe({acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.addAttachHandles((0,L.YP)(()=>this.renderingConfigHash,()=>this._update(),L.nn)),"stream"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",e=>this._edit(e)))}detach(){this._commandsQueue.clear(),this._proxy?.stop(),this.container.removeAllChildren(),this.tileRenderer?.uninstall(this.container),this.tileRenderer=null,this._tileStrategy=(0,h.SC)(this._tileStrategy),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const e="renderer"in this.layer&&null!=this.layer.renderer,t=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,c=null==this.tileRenderer||this.tileRenderer?.updating,f=e&&(t||r||i||s||c);return(0,x.Z)("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${f}\n  -> hasRenderer ${e}\n  -> hasPendingCommand ${t}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${i}\n  -> updatingPipeline ${s}\n  -> updatingTileRenderer ${c}\n`),f}_createClientOptions(){return{setUpdating:e=>{this._set("_pipelineIsUpdating",e)},emitEvent:e=>{this.emit(e.name,e.event)}}}_detectQueryMode(e){var t=this;return(0,u.Z)(function*(){const r="path"in e,{layer:i}=t,f=!("editingInfo"in i&&i.editingInfo?.lastEditDate)&&"refreshInterval"in i&&!!i.refreshInterval,R=(0,se.S1)(i);if(r&&("feature"===i.type||"subtype-group"===i.type)&&"point"===i.geometryType&&R?.query.supportsPagination&&!R?.operations.supportsEditing&&!f&&(0,x.Z)("featurelayer-snapshot-enabled"))try{const v=yield i.queryFeatureCount();if(v<=(0,x.Z)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:v};const _=(0,x.Z)("featurelayer-snapshot-point-max-threshold"),C=(0,x.Z)("featurelayer-snapshot-point-coverage"),w=t.view.extent,N=(0,h.Wg)(i.fullExtent),V=N?.clone().intersection(w),X=(0,h.pC)(V)?V.width*V.height:0,ee=N?.width*N?.height;if(v<=_&&(0===ee?0:X/ee)>=C)return{mode:"snapshot",featureCount:v}}catch(v){P.Z.getLogger(t.declaredClass).warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:v})}return{mode:"on-demand"}})()}_createServiceOptions(){var e=this;return(0,u.Z)(function*(){const t=e.layer;if("stream"===t.type)return null;const r=(0,se.S1)(t),{capabilities:i,objectIdField:s}=t,c=t.fields.map(he=>he.toJSON()),f=(0,h.pC)(t.fullExtent)?t.fullExtent.toJSON():null,R=(0,me.oq)(t.geometryType),v="timeInfo"in t&&t.timeInfo&&t.timeInfo.toJSON()||null,_=t.spatialReference?t.spatialReference.toJSON():null,C="feature"===t.type?t.globalIdField:null;let w;"ogc-feature"===t.type?w=t.source.getSource():Oe(t.source)?w=yield t.source.openPorts():t.parsedUrl&&(w=(0,Y.d9)(t.parsedUrl),"dynamicDataSource"in t&&t.dynamicDataSource&&(w.query={layer:JSON.stringify({source:t.dynamicDataSource})}));const N="datesInUnknownTimezone"in e.layer&&e.layer.datesInUnknownTimezone,V=("subtypeField"in e.layer?e.layer.subtypeField:null)??null,{mode:X,featureCount:ee}=yield e._detectQueryMode(w);let Ce=e.layer.objectIdField;if("feature"===e.layer.type&&(0,h.pC)(e.layer.orderBy)&&e.layer.orderBy.length){const he=!e.layer.orderBy[0].valueExpression&&e.layer.orderBy[0].field;he&&(Ce=he)}return{type:X,timeReferenceUnknownClient:N,subtypeField:V,featureCount:ee,globalIdField:C,maxRecordCount:i.query.maxRecordCount,tileMaxRecordCount:i.query.tileMaxRecordCount,capabilities:i,effectiveCapabilities:r,fields:c,fullExtent:f,geometryType:R,objectIdField:s,source:w,timeInfo:v,spatialReference:_,orderByFields:Ce,datesInUnknownTimezone:N,dateFieldsTimeReference:("dateFieldsTimeReference"in e.layer?e.layer.dateFieldsTimeReference?.toJSON():null)||null,preferredTimeReference:("preferredTimeReference"in e.layer?e.layer.preferredTimeReference?.toJSON():null)||null,editFieldsInfo:"editFieldsInfo"in e.layer?e.layer.editFieldsInfo?.toJSON():null}})()}_createMemoryServiceOptions(e){var t=this;return(0,u.Z)(function*(){const r=yield e.openPorts();return{...t._createServiceOptions(),type:"memory",source:r}})()}_cleanUpQuery(e){const t=oe.Z.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}_cleanUpAggregateQuery(e){const t=oe.Z.from(e)||this.createAggregateQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}_update(){var e=this;return(0,u.Z)(function*(){return e._commandsQueue.push({type:"update"})})()}_edit(e){var t=this;return(0,u.Z)(function*(){return t.suspended?void t._clearTiles():t._validateEdit(e)?t._commandsQueue.push({type:"edit",edits:e}):void 0})()}doRefresh(e){var t=this;return(0,u.Z)(function*(){if(t.attached&&t._tileStrategy.tileKeys().length)return t.suspended&&e?void t._clearTiles():t._commandsQueue.push({type:"refresh",dataChanged:e})})()}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some(s=>-1===s.objectId||!s.objectId),i=t&&this.availableFields.includes(t);return r&&!i?(P.Z.getLogger(this.declaredClass).error(new z.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null):e}_doUpdate(){var e=this;return(0,u.Z)(function*(){try{if(e.destroyed||!e._hasRequiredSupport(e.layer)||!e._tileStrategy)return;const{featureEffectView:t,filter:r}=e;if(yield e._updateRequiredFields(),e.destroyed)return;const{renderer:i}=e._getEffectiveRenderer();e._set("_effectiveRenderer",i);const s=e._createSchemaConfig(),c=e._createConfiguration(s,r,t.filter),f=e._lastDefinitionExpression!==c.schema.source.definitionExpression;e._lastDefinitionExpression=c.schema.source.definitionExpression;const R=c.schema.tileRenderer,v=e._createTileRendererHash(R);if("snapshot"===e._serviceOptions.type&&(c.schema.source.initialFeatureCount=e._serviceOptions.featureCount),v!==e._tileRendererHash){yield e._initTileRenderer(R,i);const _=e.layer,C="stream"===_.type?yield e._initServiceOptions():e._serviceOptions;e.tileRenderer.onConfigUpdate(i),"stream"!==_.type&&Oe(_.source)&&(C.source=yield _.source.openPorts());const w={added:e._tileStrategy.tileKeys(),removed:[]};yield e._proxy.startup(e.view.featuresTilingScheme,c,C,w),e.hasHighlight()&&(yield e._proxy.setHighlight(Array.from(e._highlightIds.keys()))),yield e._onceTilesUpdated(),e.tileRenderer.onConfigUpdate(i)}else{"snapshot"===e._serviceOptions.type&&f&&(c.schema.source.changedFeatureCount=yield e.layer.queryFeatureCount());const _=yield e._proxy.update(c);(_.mesh||_.targets?.aggregate)&&e._lockGPUUploads();try{yield e._proxy.applyUpdate(_)}catch(C){(0,b.D_)(C)||P.Z.getLogger(e.declaredClass).error(C)}(_.mesh||_.targets?.aggregate)&&e._unlockGPUUploads(),e.tileRenderer.onConfigUpdate(i),e._updateClusterSizeVariable(),e._forceAttributeTextureUpload()}e._tileRendererHash=v,e.tileRenderer.invalidateLabels(),e.requestUpdate()}catch{}})()}_doEdit(e){var t=this;return(0,u.Z)(function*(){try{yield t._proxy.onEdits(e)}catch(r){(0,b.D_)(r)}})()}_doRefresh(e){var t=this;return(0,u.Z)(function*(){t._lockGPUUploads();try{let r;e&&"snapshot"===t.queryMode&&"queryFeatureCount"in t.layer&&(r=yield t.layer.queryFeatureCount()),yield t._proxy.refresh({dataChanged:e,featureCount:r})}catch(r){(0,b.D_)(r)}t._unlockGPUUploads(),t._effectiveFeatureReduction&&t._updateClusterSizeVariable()})()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(e,t){return(0,L.YP)(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(e,t,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(e,t,r){var i=this;return(0,u.Z)(function*(){if(e.dynamicClusterSize&&"visualVariables"in e&&e.visualVariables){const s=(0,de.os)(e.visualVariables);if((0,h.pC)(s)&&"cluster_count"===s.field){const c=e.visualVariables.indexOf(s);e.visualVariables[c]=(0,de.aV)(t,r);const f=e.clone();f.dynamicClusterSize=!0,i._set("_effectiveRenderer",f)}}})()}_getEffectiveRenderer(){const e=this.layer,t="renderer"in e?e.renderer:null,r=this._effectiveFeatureReduction;if(this._updateClusterSizeTask=(0,h.hw)(this._updateClusterSizeTask),r&&"renderer"in r&&r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated){const i=r.fields;if("cluster"===r.type){const{renderer:s,didInject:c}=(0,de.st)(r.renderer,r,this._aggregateValueRanges);return c&&(this._updateClusterSizeTask=this._createUpdateClusterSizeTask(s,r)),{renderer:s,aggregateFields:i,featureReduction:r}}return{renderer:r.renderer,aggregateFields:i,featureReduction:r}}if(r&&"cluster"===r.type&&t&&(0,de.yR)(t)){const i=r,s=[],c=(0,de.S1)(s,t,i,this._aggregateValueRanges,!0);return this._updateClusterSizeTask=this._createUpdateClusterSizeTask(c,i),{renderer:c,aggregateFields:s,featureReduction:r}}return{renderer:t,aggregateFields:[],featureReduction:null}}_acquireTile(e){const t=this.tileRenderer.acquireTile(e);return t.once("attach",()=>{this.requestUpdate()}),t}_releaseTile(e){this.tileRenderer.releaseTile(e)}_initTileRenderer(e,t){var r=this;return(0,u.Z)(function*(){const i=yield function K(e,t){return T.apply(this,arguments)}(e,{layerView:r,tileInfoView:r.view.featuresTilingScheme,layer:r.layer});return r.tileRenderer&&(r._tileStrategy.clear(),r.tileRenderer.uninstall(r.container),r.tileRenderer=(0,h.SC)(r.tileRenderer)),r.destroyed?null:(r._proxy.tileRenderer=i,r._set("tileRenderer",i),r.tileRenderer.install(r.container),r.tileRenderer.onConfigUpdate(t),r.requestUpdate(),r.tileRenderer)})()}_createTileRendererHash(e){return`${e.type}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(e){const t=(0,h.pC)(e)?e.timeExtent:null,r=(0,h.pC)(this.timeExtent)&&(0,h.pC)(t)?this.timeExtent.intersection(t):this.timeExtent||t;let i=null;const s="floorInfo"in this.layer&&this.layer.floorInfo;if(s){const f=(0,h.pC)(e)?e.where:null;i=this._addFloorFilterClause(f)}if(!this._visibilityOverrides.size&&!r&&!s)return(0,h.pC)(e)?e.toJSON():null;(e=(0,h.pC)(e)&&e.clone()||new ie.Z).timeExtent=r,i&&(e.where=i);const c=e.toJSON();return c.hiddenIds=Array.from(this._visibilityOverrides),c}_addFloorFilterClause(e){const t=this.layer;let r=e||"";if("floorInfo"in t&&t.floorInfo){let i=this.view.floors;if(!i||!i.length)return r;t.floorInfo.viewAllLevelIds?.length&&(i=t.floorInfo.viewAllLevelIds);const s=i.filter(R=>""!==R).map(R=>"'"+R+"'");s.push("''");const c=t.floorInfo.floorField;let f="("+c+" IN ({ids}) OR "+c+" IS NULL)";if(f=f.replace("{ids}",s.join(", ")),(0,h.pC)(r)&&r.includes(c)){let R=new RegExp("AND \\("+c+".*NULL\\)","g");r=r.replace(R,""),R=new RegExp("\\("+c+".*NULL\\)","g"),r=r.replace(R,""),r=r.replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+f:f}return""!==r?r:null}_createConfiguration(e,t,r){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s="feature"===this.layer.type?this.layer.gdbVersion??void 0:void 0,c=new Array(k.m4),f=this._injectOverrides(t);c[0]=f,c[1]=(0,h.pC)(r)?r.toJSON():null;const R=(0,Z.Ew)(e);if((0,h.Wi)(R))return null;const v=(0,Me.hc)("2d");return{availableFields:this.availableFields,gdbVersion:s,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:c,schema:R,supportsTextureFloat:v.supportsTextureFloat,maxTextureSize:v.maxTextureSize}}_hasRequiredSupport(e){return!("renderer"in e)||(0,re.TT)(e.renderer)}_onceTilesUpdated(){return this.requestUpdate(),(0,L.N1)(()=>!this._pipelineIsUpdating)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){const e=this.layer;return{renderer:"renderer"in e?e.renderer:null,spatialReference:e.spatialReference,timeExtent:"timeExtent"in e?e.timeExtent:null,definitionExpression:e.definitionExpression,featureReduction:this._effectiveFeatureReduction,fields:e.fields,geometryType:e.geometryType,historicMoment:"historicMoment"in e?e.historicMoment:null,labelsVisible:"labelsVisible"in e&&e.labelsVisible,labelingInfo:"labelingInfo"in e?e.labelingInfo:null,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"gdbVersion"in e?e.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in e&&e.orderBy?e.orderBy:null,customParameters:{..."customParameters"in e?e.customParameters:void 0,token:"apiKey"in e?e.apiKey??void 0:void 0},subtypeCode:"subtypeCode"in e?e.subtypeCode:void 0,subtypeField:"subtypeField"in e?e.subtypeField:void 0}}_addHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const r=this._highlightIds.get(t);this._highlightIds.set(t,r+1)}else this._highlightIds.set(t,1);this._updateHighlight().catch(t=>{(0,b.D_)(t)||P.Z.getLogger(this.declaredClass).error(t)})}_removeHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const r=this._highlightIds.get(t)-1;0===r?this._highlightIds.delete(t):this._highlightIds.set(t,r)}this._updateHighlight().catch(t=>{(0,b.D_)(t)||P.Z.getLogger(this.declaredClass).error(t)})}_setLayersForFeature(e){const t=this.layer;e.layer=t,e.sourceLayer=t}_createGraphicHit(e,t){return this._setLayersForFeature(t),(0,h.pC)(t.geometry)&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};(0,p._)([(0,g.Cb)()],Q.prototype,"_serviceOptions",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"_proxy",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"_pipelineIsUpdating",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"_effectiveRenderer",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"_effectiveFeatureReduction",null),(0,p._)([(0,g.Cb)()],Q.prototype,"_aggregateValueRanges",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"_commandsQueue",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"featureEffectView",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"labelsVisible",null),(0,p._)([(0,g.Cb)({readOnly:!0})],Q.prototype,"queryMode",null),(0,p._)([(0,g.Cb)()],Q.prototype,"renderingConfigHash",null),(0,p._)([(0,g.Cb)()],Q.prototype,"tileRenderer",void 0),(0,p._)([(0,g.Cb)()],Q.prototype,"updating",void 0),Q=(0,p._)([(0,O.j)("esri.views.2d.layers.FeatureLayerView2D")],Q);const Le=Q},37384:(pe,$,l)=>{l.d($,{y:()=>oe});var u=l(17626),p=l(74333),G=l(89726),g=l(26584),E=l(32917),I=l(77712),S=(l(90912),l(85931),l(76898)),W=l(1011),D=l(38093),z=l(86810);let x=class extends z.wq{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,u._)([(0,I.Cb)({readOnly:!0})],x.prototype,"version",null),x=(0,u._)([(0,S.j)("esri.views.layers.support.ClipArea")],x);const Y=x;var P;let h=P=class extends Y{constructor(k){super(k),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new P({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,u._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],h.prototype,"left",void 0),(0,u._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],h.prototype,"right",void 0),(0,u._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],h.prototype,"top",void 0),(0,u._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],h.prototype,"bottom",void 0),h=P=(0,u._)([(0,S.j)("esri.views.layers.support.ClipRect")],h);const b=h;l(29132);var ie,ae=l(21674),ye=l(91179),j=l(2004),fe=l(37118);const se={base:ae.Z,key:"type",typeMap:{extent:j.Z,polygon:fe.Z}};let te=ie=class extends Y{constructor(k){super(k),this.type="geometry",this.geometry=null}clone(){return new ie({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,u._)([(0,I.Cb)({types:se,json:{read:ye.im,write:!0}})],te.prototype,"geometry",void 0),te=ie=(0,u._)([(0,S.j)("esri.views.layers.support.Geometry")],te);const ce=te;let le=class extends Y{constructor(k){super(k),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,u._)([(0,I.Cb)({type:[[[Number]]],json:{write:!0}})],le.prototype,"path",void 0),le=(0,u._)([(0,S.j)("esri.views.layers.support.Path")],le);const ue=p.Z.ofType({key:"type",base:null,typeMap:{rect:b,path:le,geometry:ce}}),oe=k=>{let q=class extends k{constructor(){super(...arguments),this.attached=!1,this.clips=new ue,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this.visibleAtCurrentScale=!1,this.highlightOptions=null}initialize(){this.view?.spatialReference&&(this.view?.spatialReferenceLocked??1)&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new g.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new W.W),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,E.YP)(()=>this.suspended,T=>{this.container&&(this.container.visible=!T),this.view&&!T&&this.updateRequested&&this.view.requestUpdate()},E.tX),(0,E.YP)(()=>this.layer?.opacity??1,T=>{this.container&&(this.container.opacity=T)},E.tX),(0,E.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",T=>{this.container&&(this.container.blendMode=T)},E.tX),(0,E.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,T=>{this.container&&(this.container.effect=T)},E.tX),(0,E.YP)(()=>this.highlightOptions,T=>this.container.highlightOptions=T,E.tX),(0,E.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},E.tX),(0,E.YP)(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:T})=>{const re=null!=T&&this.isVisibleAtScale(T);re!==this.visibleAtCurrentScale&&this._set("visibleAtCurrentScale",re)},E.tX)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(T=>{T===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){const Z=this.view?.spatialReference;return null==Z||this.supportsSpatialReference(Z)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this.updatingHandles?.updating)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}isVisibleAtScale(Z){const K=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!K)return!0;const{minScale:T,maxScale:re}=K;return(0===T||Z<=T)&&(0===re||Z>=re)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}processUpdate(Z){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",Z),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(Z))):this.updateRequested=!1}hitTest(Z,K){return Promise.resolve(null)}supportsSpatialReference(Z){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const Z=super.getSuspendInfo(),K=!this.spatialReferenceSupported,T=this.visibleAtCurrentScale;return K&&(Z.spatialReferenceNotSupported=K),T&&(Z.outsideScaleRange=T),Z}addAttachHandles(Z){this.addHandles(Z,"attach")}};return(0,u._)([(0,I.Cb)()],q.prototype,"attached",void 0),(0,u._)([(0,I.Cb)({type:ue,set(Z){const K=(0,G.Z)(Z,this._get("clips"),ue);this._set("clips",K)}})],q.prototype,"clips",void 0),(0,u._)([(0,I.Cb)()],q.prototype,"container",void 0),(0,u._)([(0,I.Cb)()],q.prototype,"moving",void 0),(0,u._)([(0,I.Cb)({readOnly:!0})],q.prototype,"spatialReferenceSupported",null),(0,u._)([(0,I.Cb)({readOnly:!0})],q.prototype,"updateParameters",void 0),(0,u._)([(0,I.Cb)()],q.prototype,"updateRequested",void 0),(0,u._)([(0,I.Cb)()],q.prototype,"updating",null),(0,u._)([(0,I.Cb)()],q.prototype,"view",void 0),(0,u._)([(0,I.Cb)({readOnly:!0})],q.prototype,"visibleAtCurrentScale",void 0),(0,u._)([(0,I.Cb)({type:D.Z})],q.prototype,"highlightOptions",void 0),q=(0,u._)([(0,S.j)("esri.views.2d.layers.LayerView2D")],q),q}},45611:(pe,$,l)=>{l.d($,{Z:()=>Y});var u=l(17626),p=l(14517),G=l(61885),g=l(80542),E=l(61996),I=l(63290),O=l(62208),J=l(60330),S=l(77712),z=(l(90912),l(85931),l(76898));let x=class extends((0,g.p)((0,E.IG)((0,J.v)(G.Z.EventedMixin(p.Z))))){constructor(P){super(P),this.layer=null,this.parent=null}initialize(){this.when().catch(P=>{if("layerview:create-error"!==P.name){const h=this.layer&&this.layer.id||"no id",b=this.layer&&this.layer.title||"no title";I.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${b}', id: '${h}')`,P)}})}get fullOpacity(){return(0,O.Pt)(this.get("layer.opacity"),1)*(0,O.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this.updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(P){this._overrideIfSome("visible",P)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const P=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(P.viewNotReady=!0),this.layer&&this.layer.loaded||(P.layerNotLoaded=!0),this.visible||(P.layerInvisible=!0),P}isUpdating(){return!1}};(0,u._)([(0,S.Cb)()],x.prototype,"fullOpacity",null),(0,u._)([(0,S.Cb)()],x.prototype,"layer",void 0),(0,u._)([(0,S.Cb)()],x.prototype,"parent",void 0),(0,u._)([(0,S.Cb)({readOnly:!0})],x.prototype,"suspended",null),(0,u._)([(0,S.Cb)({readOnly:!0})],x.prototype,"suspendInfo",null),(0,u._)([(0,S.Cb)({readOnly:!0})],x.prototype,"legendEnabled",null),(0,u._)([(0,S.Cb)({type:Boolean,readOnly:!0})],x.prototype,"updating",null),(0,u._)([(0,S.Cb)({readOnly:!0})],x.prototype,"updatingProgress",null),(0,u._)([(0,S.Cb)()],x.prototype,"visible",null),(0,u._)([(0,S.Cb)()],x.prototype,"view",void 0),x=(0,u._)([(0,z.j)("esri.views.layers.LayerView")],x);const Y=x},94421:(pe,$,l)=>{l.d($,{Z:()=>S});var u=l(17626),p=l(63290),G=l(10699),g=l(32917),E=l(77712),J=(l(90912),l(85931),l(76898));const S=W=>{let D=class extends W{initialize(){this.handles.add((0,g.on)(()=>this.layer,"refresh",z=>{this.doRefresh(z.dataChanged).catch(x=>{(0,G.D_)(x)||p.Z.getLogger(this.declaredClass).error(x)})}),"RefreshableLayerView")}};return(0,u._)([(0,E.Cb)()],D.prototype,"layer",void 0),D=(0,u._)([(0,J.j)("esri.layers.mixins.RefreshableLayerView")],D),D}},10023:(pe,$,l)=>{l.d($,{V:()=>I,e:()=>g});var u=l(15861),p=l(62208),G=l(36630);function g(O){return E.apply(this,arguments)}function E(){return(E=(0,u.Z)(function*(O,J=O.popupTemplate){if((0,p.Wi)(J))return[];const S=yield J.getRequiredFields(O.fieldsIndex),{lastEditInfoEnabled:W}=J,{objectIdField:D,typeIdField:z,globalIdField:x,relationships:Y}=O;if(S.includes("*"))return["*"];const P=W?yield(0,G.CH)(O):[],h=(0,G.Q0)(O.fieldsIndex,[...S,...P]);return z&&h.push(z),h&&D&&O.fieldsIndex?.has(D)&&!h.includes(D)&&h.push(D),h&&x&&O.fieldsIndex?.has(x)&&!h.includes(x)&&h.push(x),Y&&Y.forEach(b=>{const{keyField:L}=b;h&&L&&O.fieldsIndex?.has(L)&&!h.includes(L)&&h.push(L)}),h})).apply(this,arguments)}function I(O,J){return O.popupTemplate?O.popupTemplate:(0,p.pC)(J)&&J.defaultPopupTemplateEnabled&&(0,p.pC)(O.defaultPopupTemplate)?O.defaultPopupTemplate:null}}}]);