"use strict";(self.webpackChunkarcgis=self.webpackChunkarcgis||[]).push([[3789],{26268:(I,u,t)=>{t.d(u,{Z:()=>d});var n=t(8314),h=t(39406),E=t(44589),c=t(8650),M=t(13382);const o=(l,r)=>l.key.level-r.key.level!=0?l.key.level-r.key.level:l.key.row-r.key.row!=0?l.key.row-r.key.row:l.key.col-r.key.col;class d extends E.Z{constructor(r){super(),this._tileInfoView=r}get requiresDedicatedFBO(){return!1}renderChildren(r){this.sortChildren(o),this.setStencilReference(r),super.renderChildren(r)}createRenderParams(r){const{state:_}=r,a=super.createRenderParams(r);return a.requiredLevel=this._tileInfoView.getClosestInfoForScale(_.scale).level,a.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(_.scale),a}prepareRenderPasses(r){const _=super.prepareRenderPasses(r);return _.push(r.registerRenderPass({name:"stencil",brushes:[M.Z],drawPhase:h.jx.DEBUG|h.jx.MAP|h.jx.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,n.Z)("esri-tiles-debug")&&_.push(r.registerRenderPass({name:"tileInfo",brushes:[c.Z],drawPhase:h.jx.DEBUG,target:()=>this.children})),_}getStencilTarget(){return this.children}setStencilReference(r){let _=1;for(const a of this.children)a.stencilRef=_++}}},43783:(I,u,t)=>{t.d(u,{I:()=>c});var n=t(30217),h=t(57477),E=t(58098);class c extends h.s{constructor(o,d,l,r,_,a,f=_,y=a){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new E.Z(o),this.resolution=d,this.x=l,this.y=r,this.width=_,this.height=a,this.rangeX=f,this.rangeY=y}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(o){const d=this.resolution/(o.resolution*o.pixelRatio),l=this.transforms.tileMat3,[r,_]=o.toScreenNoRotation([0,0],[this.x,this.y]);(0,n.s)(l,this.width/this.rangeX*d,0,0,0,this.height/this.rangeY*d,0,r,_,1),(0,n.m)(this.transforms.dvs,o.displayViewMat3,l)}}},49300:(I,u,t)=>{t.r(u),t.d(u,{default:()=>K});var n=t(15861),h=t(17626),E=t(63290),c=t(10699),M=t(32917),o=t(77712),r=(t(90912),t(85931),t(76898)),_=t(37053),a=t(91082),f=t(37384),y=t(88893),m=t(9598),T=t(58098),U=t(8480),B=t(79527),j=t(45611),S=t(94421);const W=[102113,102100,3857,3785,900913],A=[0,0];let P=class extends((0,S.Z)((0,a.Y)((0,f.y)(j.Z)))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this._tileRequests=new Map,this.layer=null}get tileMatrixSet(){const e=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);return e?(e.id!==this.layer.activeLayer.tileMatrixSetId&&(this.layer.activeLayer.tileMatrixSetId=e.id),e):null}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume()}attach(){const e=this.tileMatrixSet?.tileInfo;e&&(this._tileInfoView=new m.Z(e),this._fetchQueue=new U.Z({tileInfoView:this._tileInfoView,concurrency:16,process:(s,i)=>this.fetchTile(s,i)}),this._tileStrategy=new B.Z({cachePolicy:"keep",resampling:!0,acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),tileInfoView:this._tileInfoView}),this.addAttachHandles((0,M.YP)(()=>[this.layer?.activeLayer?.styleId,this.tileMatrixSet],()=>this._refresh())),super.attach())}detach(){super.detach(),this._tileStrategy?.destroy(),this._fetchQueue?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once("detach",()=>e.destroy()),this.requestUpdate()}acquireTile(e){const s=this._bitmapView.createTile(e),i=s.bitmap;return[i.x,i.y]=this._tileInfoView.getTileCoords(A,s.key),i.resolution=this._tileInfoView.getTileResolution(s.key),[i.width,i.height]=this._tileInfoView.tileInfo.size,this._enqueueTileFetch(s),this._bitmapView.addChild(s),this.requestUpdate(),s}doRefresh(){var e=this;return(0,n.Z)(function*(){!e.attached||e.updateRequested||e.suspended||e._refresh()})()}isUpdating(){return this._fetchQueue?.updating??!1}fetchTile(e,s={}){var i=this;return(0,n.Z)(function*(){const D="tilemapCache"in i.layer?i.layer.tilemapCache:null,{signal:p,resamplingLevel:v=0}=s;if(!D)return i._fetchImage(e,p);const O=new T.Z(0,0,0,0);let R;try{yield D.fetchAvailabilityUpsample(e.level,e.row,e.col,O,{signal:p}),R=yield i._fetchImage(O,p)}catch(g){if((0,c.D_)(g))throw g;if(v<3){const L=i._tileInfoView.getTileParentId(e.id);if(L){const C=new T.Z(L),x=yield i.fetchTile(C,{...s,resamplingLevel:v+1});return(0,y.i)(i._tileInfoView,x,C,e)}}throw g}return(0,y.i)(i._tileInfoView,R,O,e)})()}canResume(){return super.canResume()&&null!==this.tileMatrixSet}supportsSpatialReference(e){return this.layer.activeLayer.tileMatrixSets?.some(s=>(0,_.fS)(s.tileInfo?.spatialReference,e))??!1}_enqueueTileFetch(e){var s=this;return(0,n.Z)(function*(){if(!s._fetchQueue.has(e.key.id)){try{const i=yield s._fetchQueue.push(e.key);e.bitmap.source=i,e.bitmap.width=s._tileInfoView.tileInfo.size[0],e.bitmap.height=s._tileInfoView.tileInfo.size[1],e.once("attach",()=>s.requestUpdate())}catch(i){(0,c.D_)(i)||E.Z.getLogger(s.declaredClass).error(i)}s.requestUpdate()}})()}_fetchImage(e,s){var i=this;return(0,n.Z)(function*(){return i.layer.fetchImageBitmapTile(e.level,e.row,e.col,{signal:s})})()}_refresh(){this._fetchQueue.reset(),this._tileStrategy.tiles.forEach(e=>{if(!e.bitmap.source)return;const s={id:e.key.id,fulfilled:!1,promise:this._fetchQueue.push(e.key).then(i=>{e.bitmap.source=i}).catch(i=>{(0,c.D_)(i)||(e.bitmap.source=null)}).finally(()=>{e.requestRender(),s.fulfilled=!0})};this._tileRequests.set(e,s)})}_getTileMatrixSetBySpatialReference(e){const s=this.view.spatialReference;if(!e.tileMatrixSets)return null;let i=e.tileMatrixSets.find(D=>(0,_.fS)(D.tileInfo?.spatialReference,s));return!i&&s.isWebMercator&&(i=e.tileMatrixSets.find(D=>W.includes(D.tileInfo?.spatialReference.wkid??-1))),i}};(0,h._)([(0,o.Cb)()],P.prototype,"_fetchQueue",void 0),(0,h._)([(0,o.Cb)({readOnly:!0})],P.prototype,"tileMatrixSet",null),P=(0,h._)([(0,r.j)("esri.views.2d.layers.WMTSLayerView2D")],P);const K=P},94421:(I,u,t)=>{t.d(u,{Z:()=>r});var n=t(17626),h=t(63290),E=t(10699),c=t(32917),M=t(77712),l=(t(90912),t(85931),t(76898));const r=_=>{let a=class extends _{initialize(){this.handles.add((0,c.on)(()=>this.layer,"refresh",f=>{this.doRefresh(f.dataChanged).catch(y=>{(0,E.D_)(y)||h.Z.getLogger(this.declaredClass).error(y)})}),"RefreshableLayerView")}};return(0,n._)([(0,M.Cb)()],a.prototype,"layer",void 0),a=(0,n._)([(0,l.j)("esri.layers.mixins.RefreshableLayerView")],a),a}}}]);