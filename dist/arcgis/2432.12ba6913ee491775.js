"use strict";(self.webpackChunkarcgis=self.webpackChunkarcgis||[]).push([[2432,587,1404],{42432:(G,L,s)=>{s.d(L,{xp:()=>$,Vt:()=>P});var h=s(15861),d=s(17626),Z=s(84792),f=s(26584),S=s(63290),N=s(62208),C=s(10699),A=s(21726),p=s(77712),x=(s(90912),s(85931),s(68653)),U=s(76898),u=s(99433),c=s(52489),v=s(2004),_=s(79334),E=s(65234),D=s(38305),b=s(13812),n=s(60595);var T=s(84687),F=s(55463),j=s(71404);const w="esri.layers.mixins.SceneService",K=S.Z.getLogger(w),P=O=>{let y=class extends O{constructor(){var r;super(...arguments),r=this,this.spatialReference=null,this.fullExtent=null,this.heightModelInfo=null,this.minScale=0,this.maxScale=0,this.version={major:Number.NaN,minor:Number.NaN,versionString:""},this.copyright=null,this.sublayerTitleMode="item-title",this.title=null,this.layerId=null,this.indexInfo=null,this._debouncedSaveOperations=(0,C.Ds)(function(){var e=(0,h.Z)(function*(t,o,a){switch(t){case $.SAVE:return r._save(o);case $.SAVE_AS:return r._saveAs(a,o)}});return function(t,o,a){return e.apply(this,arguments)}}())}readSpatialReference(r,e){return this._readSpatialReference(e)}_readSpatialReference(r){if(null!=r.spatialReference)return E.Z.fromJSON(r.spatialReference);{const e=r.store,t=e.indexCRS||e.geographicCRS,o=t&&parseInt(t.substring(t.lastIndexOf("/")+1,t.length),10);return null!=o?new E.Z(o):null}}readFullExtent(r,e,t){if(null!=r&&"object"==typeof r){const I=null==r.spatialReference?{...r,spatialReference:this._readSpatialReference(e)}:r;return v.Z.fromJSON(I,t)}const o=e.store,a=this._readSpatialReference(e);return null==a||null==o||null==o.extent||!Array.isArray(o.extent)||o.extent.some(I=>I<z)?null:new v.Z({xmin:o.extent[0],ymin:o.extent[1],xmax:o.extent[2],ymax:o.extent[3],spatialReference:a})}parseVersionString(r){const e={major:Number.NaN,minor:Number.NaN,versionString:r},t=r.split(".");return t.length>=2&&(e.major=parseInt(t[0],10),e.minor=parseInt(t[1],10)),e}readVersion(r,e){const t=e.store,o=null!=t.version?t.version.toString():"";return this.parseVersionString(o)}readTitlePortalItem(r){return"item-title"!==this.sublayerTitleMode?void 0:r}readTitleService(r,e){const t=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return(0,D.a7)(this.url,e.name);let o=e.name;if(!o&&this.url){const a=(0,D.Qc)(this.url);(0,N.pC)(a)&&(o=a.title)}return"item-title-and-service-name"===this.sublayerTitleMode&&t&&(o=t+" - "+o),(0,D.ld)(o)}set url(r){const e=(0,D.XG)({layer:this,url:r,nonStandardUrlAllowed:!1,logger:K});this._set("url",e.url),null!=e.layerId&&this._set("layerId",e.layerId)}writeUrl(r,e,t,o){(0,D.wH)(this,r,"layers",e,o)}get parsedUrl(){const r=this._get("url"),e=(0,A.mN)(r);return null!=this.layerId&&(e.path=`${e.path}/layers/${this.layerId}`),e}_fetchIndexAndUpdateExtent(r,e){var t=this;return(0,h.Z)(function*(){t.indexInfo=(0,n.T)(t.parsedUrl.path,t.rootNode,r,t.apiKey,K,e),null==t.fullExtent||t.fullExtent.hasZ||t._updateExtent(yield t.indexInfo)})()}_updateExtent(r){if("page"===r?.type){const t=r.rootPage?.nodes?.[r.rootIndex%r.pageSize];if(null==t||null==t.obb||null==t.obb.center||null==t.obb.halfSize)throw new f.Z("sceneservice:invalid-node-page","Invalid node page.");if(t.obb.center[0]<z||null==this.fullExtent||this.fullExtent.hasZ)return;const o=t.obb.halfSize,a=t.obb.center[2],I=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]);this.fullExtent.zmin=a-I,this.fullExtent.zmax=a+I}else if("node"===r?.type){const e=r.rootNode?.mbs;if(!Array.isArray(e)||4!==e.length||e[0]<z)return;const t=e[2],o=e[3],{fullExtent:a}=this;a&&(a.zmin=t-o,a.zmax=t+o)}}_fetchService(r){var e=this;return(0,h.Z)(function*(){if(null==e.url)throw new f.Z("sceneservice:url-not-set","Scene service can not be loaded without valid portal item or url");if(null==e.layerId&&/SceneServer\/*$/i.test(e.url)){const t=yield e._fetchFirstLayerId(r);null!=t&&(e.layerId=t)}return e._fetchServiceLayer(r)})()}_fetchFirstLayerId(r){var e=this;return(0,h.Z)(function*(){const t=yield(0,Z.default)(e.url,{query:{f:"json",token:e.apiKey},responseType:"json",signal:r});if(t.data&&Array.isArray(t.data.layers)&&t.data.layers.length>0)return t.data.layers[0].id})()}_fetchServiceLayer(r){var e=this;return(0,h.Z)(function*(){const t=yield(0,Z.default)(e.parsedUrl?.path??"",{query:{f:"json",token:e.apiKey},responseType:"json",signal:r});t.ssl&&(e.url=e.url.replace(/^http:/i,"https:"));let o=!1;if(t.data.layerType&&"Voxel"===t.data.layerType&&(o=!0),o)return e._fetchVoxelServiceLayer();const a=t.data;e.read(a,e._getServiceContext()),e.validateLayer(a)})()}_fetchVoxelServiceLayer(r){var e=this;return(0,h.Z)(function*(){const t=(yield(0,Z.default)(e.parsedUrl?.path+"/layer",{query:{f:"json",token:e.apiKey},responseType:"json",signal:r})).data;e.read(t,e._getServiceContext()),e.validateLayer(t)})()}_getServiceContext(){return{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}}_ensureLoadBeforeSave(){var r=this;return(0,h.Z)(function*(){yield r.load(),"beforeSave"in r&&"function"==typeof r.beforeSave&&(yield r.beforeSave())})()}validateLayer(r){}_updateTypeKeywords(r,e,t){r.typeKeywords||(r.typeKeywords=[]);const o=e.getTypeKeywords();for(const a of o)r.typeKeywords.push(a);r.typeKeywords&&(r.typeKeywords=r.typeKeywords.filter((a,I,M)=>M.indexOf(a)===I),t===W.newItem&&(r.typeKeywords=r.typeKeywords.filter(a=>"Hosted Service"!==a)))}_saveAs(r,e){var t=this;return(0,h.Z)(function*(){const o={...H,...e};let a=F.default.from(r);a||(K.error("_saveAs(): requires a portal item parameter"),yield Promise.reject(new f.Z("sceneservice:portal-item-required","_saveAs() requires a portal item to save to"))),a.id&&(a=a.clone(),a.id=null);const I=a.portal||T.Z.getDefault();yield t._ensureLoadBeforeSave(),a.type=V,a.portal=I;const M={origin:"portal-item",url:null,messages:[],portal:I,portalItem:a,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},g={layers:[t.write({},M)]};return yield Promise.all(M.resources.pendingOperations??[]),yield t._validateAgainstJSONSchema(g,M,o),a.url=t.url,a.title||(a.title=t.title),t._updateTypeKeywords(a,o,W.newItem),yield I.signIn(),yield I.user?.addItem({item:a,folder:o&&o.folder,data:g}),yield(0,j.saveResources)(t.resourceReferences,M,null),t.portalItem=a,(0,c.D)(M),M.portalItem=a,a})()}_save(r){var e=this;return(0,h.Z)(function*(){const t={...H,...r};if(!e.portalItem)throw K.error("_save(): requires the .portalItem property to be set"),new f.Z("sceneservice:portal-item-not-set","Portal item to save to has not been set on this SceneService");if(e.portalItem.type!==V)throw K.error("_save(): Non-matching portal item type. Got "+e.portalItem.type+", expected "+V),new f.Z("sceneservice:portal-item-wrong-type",`Portal item needs to have type "${V}"`);yield e._ensureLoadBeforeSave();const o={origin:"portal-item",url:e.portalItem.itemUrl&&(0,A.mN)(e.portalItem.itemUrl),messages:[],portal:e.portalItem.portal||T.Z.getDefault(),portalItem:e.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},a={layers:[e.write({},o)]};return yield Promise.all(o.resources.pendingOperations??[]),yield e._validateAgainstJSONSchema(a,o,t),e.portalItem.url=e.url,e.portalItem.title||(e.portalItem.title=e.title),e._updateTypeKeywords(e.portalItem,t,W.existingItem),yield e.portalItem.update({data:a}),yield(0,j.saveResources)(e.resourceReferences,o,null),(0,c.D)(o),e.portalItem})()}_validateAgainstJSONSchema(r,e,t){return(0,h.Z)(function*(){let o=e.messages?.filter(g=>"error"===g.type).map(g=>new f.Z(g.name,g.message,g.details))??[];t?.validationOptions?.ignoreUnsupported&&(o=o.filter(g=>"layer:unsupported"!==g.name&&"symbol:unsupported"!==g.name&&"symbol-layer:unsupported"!==g.name&&"property:unsupported"!==g.name&&"url:unsupported"!==g.name&&"scenemodification:unsupported"!==g.name));const a=t?.validationOptions,I=a?.enabled,M=null;if(I&&M){const g=(yield M()).validate(r,t.portalItemLayerType);if(g.length>0){const J=`Layer item did not validate:\n${g.join("\n")}`;if(K.error(`_validateAgainstJSONSchema(): ${J}`),"throw"===a.failPolicy){const Q=g.map(X=>new f.Z("sceneservice:schema-validation",X)).concat(o);throw new f.Z("sceneservice-validate:error","Failed to save layer item due to schema validation, see `details.errors`.",{combined:Q})}}}if(o.length>0)throw new f.Z("sceneservice:save","Failed to save SceneService due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:o})})()}};return(0,d._)([(0,p.Cb)(b.id)],y.prototype,"id",void 0),(0,d._)([(0,p.Cb)({type:E.Z})],y.prototype,"spatialReference",void 0),(0,d._)([(0,x.r)("spatialReference",["spatialReference","store.indexCRS","store.geographicCRS"])],y.prototype,"readSpatialReference",null),(0,d._)([(0,p.Cb)({type:v.Z})],y.prototype,"fullExtent",void 0),(0,d._)([(0,x.r)("fullExtent",["fullExtent","store.extent","spatialReference","store.indexCRS","store.geographicCRS"])],y.prototype,"readFullExtent",null),(0,d._)([(0,p.Cb)({readOnly:!0,type:_.Z})],y.prototype,"heightModelInfo",void 0),(0,d._)([(0,p.Cb)({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:{source:"minScale"},write:!1}}}})],y.prototype,"minScale",void 0),(0,d._)([(0,p.Cb)({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:{source:"maxScale"},write:!1}}}})],y.prototype,"maxScale",void 0),(0,d._)([(0,p.Cb)({readOnly:!0})],y.prototype,"version",void 0),(0,d._)([(0,x.r)("version",["store.version"])],y.prototype,"readVersion",null),(0,d._)([(0,p.Cb)({type:String,json:{read:{source:"copyrightText"}}})],y.prototype,"copyright",void 0),(0,d._)([(0,p.Cb)({type:String,json:{read:!1}})],y.prototype,"sublayerTitleMode",void 0),(0,d._)([(0,p.Cb)({type:String})],y.prototype,"title",void 0),(0,d._)([(0,x.r)("portal-item","title")],y.prototype,"readTitlePortalItem",null),(0,d._)([(0,x.r)("service","title",["name"])],y.prototype,"readTitleService",null),(0,d._)([(0,p.Cb)({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{write:{target:"id",isRequired:!0,ignoreOrigin:!0},read:!1}}}})],y.prototype,"layerId",void 0),(0,d._)([(0,p.Cb)(b.HQ)],y.prototype,"url",null),(0,d._)([(0,u.c)("url")],y.prototype,"writeUrl",null),(0,d._)([(0,p.Cb)()],y.prototype,"parsedUrl",null),(0,d._)([(0,p.Cb)({readOnly:!0})],y.prototype,"store",void 0),(0,d._)([(0,p.Cb)({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],y.prototype,"rootNode",void 0),y=(0,d._)([(0,U.j)(w)],y),y},z=-1e38;var W,O;(O=W||(W={}))[O.existingItem=0]="existingItem",O[O.newItem=1]="newItem";const V="Scene Service",H={getTypeKeywords:()=>[],portalItemLayerType:"unknown",validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:"throw"}};var $;!function(O){O[O.SAVE=0]="SAVE",O[O.SAVE_AS=1]="SAVE_AS"}($||($={}))},60595:(G,L,s)=>{s.d(L,{T:()=>S});var h=s(15861),d=s(84792),Z=s(26584),f=s(62208);function S(C,A,p,B,R,x){return N.apply(this,arguments)}function N(){return(N=(0,h.Z)(function*(C,A,p,B,R,x){let U=null;if((0,f.pC)(p)){const v=`${C}/nodepages/`,_=v+Math.floor(p.rootIndex/p.nodesPerPage);try{return{type:"page",rootPage:(yield(0,d.default)(_,{query:{f:"json",token:B},responseType:"json",signal:x})).data,rootIndex:p.rootIndex,pageSize:p.nodesPerPage,lodMetric:p.lodSelectionMetricType,urlPrefix:v}}catch(E){(0,f.pC)(R)&&R.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",_,E),U=E}}if(!A)return null;const u=`${C}/nodes/`,c=u+(A&&A.split("/").pop());try{return{type:"node",rootNode:(yield(0,d.default)(c,{query:{f:"json",token:B},responseType:"json",signal:x})).data,urlPrefix:u}}catch(v){throw new Z.Z("sceneservice:root-node-missing","Root node missing.",{pageError:U,nodeError:v,url:c})}})).apply(this,arguments)}},10587:(G,L,s)=>{s.r(L),s.d(L,{addOrUpdateResource:()=>A,contentToBlob:()=>_,fetchResources:()=>N,getSiblingOfSameType:()=>D,getSiblingOfSameTypeI:()=>b,removeAllResources:()=>x,removeResource:()=>B,splitPrefixFileNameAndExtension:()=>c});var h=s(15861),d=s(84792),Z=s(26584),f=s(62208),S=s(21726);function N(n){return C.apply(this,arguments)}function C(){return(C=(0,h.Z)(function*(n,l={},i){yield n.load(i);const m=(0,S.v_)(n.itemUrl,"resources"),{start:T=1,num:F=10,sortOrder:j="asc",sortField:w="created"}=l,K={query:{start:T,num:F,sortOrder:j,sortField:w,token:n.apiKey},signal:(0,f.U2)(i,"signal")},P=yield n.portal.request(m,K);return{total:P.total,nextStart:P.nextStart,resources:P.resources.map(({created:z,size:W,resource:V})=>({created:new Date(z),size:W,resource:n.resourceFromPath(V)}))}})).apply(this,arguments)}function A(n,l,i,m){return p.apply(this,arguments)}function p(){return(p=(0,h.Z)(function*(n,l,i,m){if(!n.hasPath())throw new Z.Z(`portal-item-resource-${l}:invalid-path`,"Resource does not have a valid path");const T=n.portalItem;yield T.load(m);const F=(0,S.v_)(T.userItemUrl,"add"===l?"addResources":"updateResources"),[j,w]=u(n.path),K=yield _(i),P=new FormData;return j&&"."!==j&&P.append("resourcesPrefix",j),(0,f.pC)(m)&&m.compress&&P.append("compress","true"),P.append("fileName",w),P.append("file",K,w),P.append("f","json"),(0,f.pC)(m)&&m.access&&P.append("access",m.access),yield T.portal.request(F,{method:"post",body:P,signal:(0,f.U2)(m,"signal")}),n})).apply(this,arguments)}function B(n,l,i){return R.apply(this,arguments)}function R(){return(R=(0,h.Z)(function*(n,l,i){if(!l.hasPath())throw new Z.Z("portal-item-resources-remove:invalid-path","Resource does not have a valid path");yield n.load(i);const m=(0,S.v_)(n.userItemUrl,"removeResources");yield n.portal.request(m,{method:"post",query:{resource:l.path},signal:(0,f.U2)(i,"signal")}),l.portalItem=null})).apply(this,arguments)}function x(n,l){return U.apply(this,arguments)}function U(){return(U=(0,h.Z)(function*(n,l){yield n.load(l);const i=(0,S.v_)(n.userItemUrl,"removeResources");return n.portal.request(i,{method:"post",query:{deleteAll:!0},signal:(0,f.U2)(l,"signal")})})).apply(this,arguments)}function u(n){const l=n.lastIndexOf("/");return-1===l?[".",n]:[n.slice(0,l),n.slice(l+1)]}function c(n){const[l,i]=function v(n){const l=(0,S.Ml)(n);return(0,f.Wi)(l)?[n,""]:[n.slice(0,n.length-l.length-1),`.${l}`]}(n),[m,T]=u(l);return[m,T,i]}function _(n){return E.apply(this,arguments)}function E(){return(E=(0,h.Z)(function*(n){return n instanceof Blob?n:(yield(0,d.default)(n.url,{responseType:"blob"})).data})).apply(this,arguments)}function D(n,l){if(!n.hasPath())return null;const[i,,m]=c(n.path);return n.portalItem.resourceFromPath((0,S.v_)(i,l+m))}function b(n,l){if(!n.hasPath())return null;const[i,,m]=c(n.path);return n.portalItem.resourceFromPath((0,S.v_)(i,l+m))}},71404:(G,L,s)=>{s.r(L),s.d(L,{saveResources:()=>A});var h=s(15861),d=s(59213),Z=s(26584),f=s(62208),S=s(10699),N=s(35948),C=s(10587);function A(u,c,v){return p.apply(this,arguments)}function p(){return(p=(0,h.Z)(function*(u,c,v){if(!c||!c.resources)return;const _=c.portalItem===u.portalItem?new Set(u.paths):new Set;u.paths.length=0,u.portalItem=c.portalItem;const E=new Set(c.resources.toKeep.map(i=>i.resource.path)),D=new Set,b=[];E.forEach(i=>{_.delete(i),u.paths.push(i)});for(const i of c.resources.toUpdate)if(_.delete(i.resource.path),E.has(i.resource.path)||D.has(i.resource.path)){const{resource:m,content:T,finish:F,error:j}=i,w=(0,C.getSiblingOfSameTypeI)(m,(0,N.D)());u.paths.push(w.path),b.push(B({resource:w,content:T,compress:i.compress,finish:F,error:j},v))}else u.paths.push(i.resource.path),b.push(x(i,v)),D.add(i.resource.path);for(const i of c.resources.toAdd)b.push(B(i,v)),u.paths.push(i.resource.path);if(_.forEach(i=>{if(c.portalItem){const m=c.portalItem.resourceFromPath(i);b.push(m.portalItem.removeResource(m).catch(()=>{}))}}),0===b.length)return;const n=yield(0,S.as)(b);(0,S.k_)(v);const l=n.filter(i=>"error"in i).map(i=>i.error);if(l.length>0)throw new Z.Z("save:resources","Failed to save one or more resources",{errors:l})})).apply(this,arguments)}function B(u,c){return R.apply(this,arguments)}function R(){return(R=(0,h.Z)(function*(u,c){const v={...(0,f.pC)(c)?c:{},compress:u.compress},_=yield(0,d.q6)(u.resource.portalItem.addResource(u.resource,u.content,v));if(!0!==_.ok)throw u.error?.(_.error),_.error;u.finish?.(u.resource)})).apply(this,arguments)}function x(u,c){return U.apply(this,arguments)}function U(){return(U=(0,h.Z)(function*(u,c){const v=yield(0,d.q6)(u.resource.update(u.content,c));if(!0!==v.ok)throw u.error?.(v.error),v.error;u.finish?.(u.resource)})).apply(this,arguments)}}}]);