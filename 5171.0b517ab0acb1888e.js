"use strict";(self.webpackChunkarcgis=self.webpackChunkarcgis||[]).push([[5171],{90512:(ie,Y,h)=>{h.d(Y,{Z:()=>q});var p=h(15861);class q{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(Z,R,G){this._layerById[R]=G,this._layerByName[Z]=G}featureSetByName(Z,R=!0,G=["*"]){var M=this;return(0,p.Z)(function*(){return void 0===M._layerByName[Z]?null:M._layerByName[Z]})()}featureSetById(Z,R=!0,G=["*"]){var M=this;return(0,p.Z)(function*(){return void 0===M._layerById[Z]?null:M._layerById[Z]})()}castToText(Z=!1){return"object, FeatureSetCollection"}}},85171:(ie,Y,h)=>{h.r(Y),h.d(Y,{constructAssociationMetaDataFeatureSetFromUrl:()=>Le,constructFeatureSet:()=>re,constructFeatureSetFromPortalItem:()=>Be,constructFeatureSetFromRelationship:()=>Ze,constructFeatureSetFromUrl:()=>ue,convertToFeatureSet:()=>Ue,createFeatureSetCollectionFromMap:()=>je,createFeatureSetCollectionFromService:()=>ke,initialiseMetaDataCache:()=>Oe});var p=h(15861),q=h(84792),X=h(90512),Z=h(53997),R=h(88879),G=h(47562),M=h(52724),D=h(95896),g=h(49086),b=h(91510),A=h(57366),f=h(77132),d=h(83947),O=h(45333),o=h(47982),v=h(10410);class P{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const e=new P;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,n){const r=new P;r.field=e;const s=v.WhereClause.create(t,n),i=function x(E){if("function"===E.parseTree.type){if(0===E.parseTree.args.value.length)return{name:E.parseTree.name,expr:null};if(E.parseTree.args.value.length>1)throw new o.eS(o.f.MissingStatisticParameters);const e=v.WhereClause.create((0,d.XF)(E.parseTree.args.value[0],f.Bj.Standardised,E.parameters),E.fieldsIndex);return{name:E.parseTree.name,expr:e}}return null}(s);if(null===i)throw new o.eS(o.f.UnsupportedSqlFunction,{function:""});const l=i.name.toUpperCase().trim();if("MIN"===l){if(r.typeofstat="MIN",r.workingexpr=i.expr,null===s)throw new o.eS(o.f.InvalidFunctionParameters,{function:"min"})}else if("MAX"===l){if(r.typeofstat="MAX",r.workingexpr=i.expr,null===s)throw new o.eS(o.f.InvalidFunctionParameters,{function:"max"})}else if("COUNT"===l)r.typeofstat="COUNT",r.workingexpr=i.expr;else if("STDEV"===l){if(r.typeofstat="STDDEV",r.workingexpr=i.expr,null===s)throw new o.eS(o.f.InvalidFunctionParameters,{function:"stdev"})}else if("SUM"===l){if(r.typeofstat="SUM",r.workingexpr=i.expr,null===s)throw new o.eS(o.f.InvalidFunctionParameters,{function:"sum"})}else if("MEAN"===l){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===s)throw new o.eS(o.f.InvalidFunctionParameters,{function:l})}else if("AVG"===l){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===s)throw new o.eS(o.f.InvalidFunctionParameters,{function:"avg"})}else{if("VAR"!==l)throw new o.eS(o.f.UnsupportedSqlFunction,{function:l});if(r.typeofstat="VAR",r.workingexpr=i.expr,null===s)throw new o.eS(o.f.InvalidFunctionParameters,{function:"var"})}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var I=h(50011),y=h(65234),u=h(36255),m=h(60466);function F(E){if(!E)return"COUNT";switch(E.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class S extends g.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){var t=this;return(0,p.Z)(function*(){if(null===t._wset){const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,t._wset}return t._wset})()}_isInFeatureSet(){return f.dj.InFeatureSet}_nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,n=1;const r=this._parent?this._parent.getFieldsIndex():new m.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let i=!1;for(let l=0;l<this._config.groupbyfields.length;l++)if(this._config.groupbyfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(let l=0;l<this._config.statsfields.length;l++)if(this._config.statsfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}for(const i of this._config.statsfields){const l=new P;l.field=i.name,l.tofieldname=i.name,l.workingexpr=i.expression instanceof v.WhereClause?i.expression:v.WhereClause.create(i.expression,r),l.typeofstat=F(i.statistic),this._decodedStatsfield.push(l)}this._decodedGroupbyfield=[];for(const i of this._config.groupbyfields){const l={name:i.name,singlefield:null,tofieldname:i.name,expression:i.expression instanceof v.WhereClause?i.expression:v.WhereClause.create(i.expression,r)};this._decodedGroupbyfield.push(l)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const i of this._parent.fields)e[i.name.toUpperCase()]=1;this.types=null}else this.geometryType=f.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new y.Z({wkid:4326});this.fields=[];const s=new P;s.field=this._nextUniqueName(e),s.tofieldname=this.objectIdField,s.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),s.typeofstat="MIN",this._decodedStatsfield.push(s);for(const i of this._decodedGroupbyfield){const l=new u.Z;if(i.name=this._nextUniqueName(e),l.name=i.tofieldname,l.alias=l.name,(0,d.y5)(i.expression)){const a=this._parent.getField((0,d.zR)(i.expression,f.Bj.Standardised));if(!a)throw new o.EN(o.H9.AggregationFieldNotFound);i.name=a.name,i.singlefield=a.name,this.phsyicalgroupbyfields.push(a.name),l.type=a.type}else{l.type=this._convertToEsriFieldType((0,d.DT)(i.expression,this._parent.fields));const a=new u.Z;a.name=i.name,a.alias=a.name,this.phsyicalgroupbyfields.push(i.name),this._adaptedFields.push(new M.yN(a,i.expression)),this._candosimplegroupby=!1}this.fields.push(l)}if(this._adaptedFields.length>0)for(const i of this._parent.fields)this._adaptedFields.push(new M.$X(i));for(let i=0;i<this._decodedStatsfield.length;i++){const l=new u.Z;let a=null;const c=this._decodedStatsfield[i];c.field=this._nextUniqueName(e),c.tofieldname===this.objectIdField&&(this._internalObjectIdField=c.field),l.name=c.tofieldname,l.alias=l.name;const _=null!==c.workingexpr&&(0,d.y5)(c.workingexpr)?(0,d.zR)(c.workingexpr,f.Bj.Standardised):"";switch(this._decodedStatsfield[i].typeofstat){case"SUM":if(""!==_){if(a=this._parent.getField(_),!a)throw new o.EN(o.H9.AggregationFieldNotFound);l.type=a.type}else l.type="double";break;case"MIN":case"MAX":if(""!==_){if(a=this._parent.getField(_),!a)throw new o.EN(o.H9.AggregationFieldNotFound);l.type=a.type}else l.type="double";break;case"COUNT":l.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==_&&(a=this._parent.getField(_),!a))throw new o.EN(o.H9.AggregationFieldNotFound);l.type="double"}this.fields.push(l)}}_canDoAggregates(){return(0,p.Z)(function*(){return!1})()}_getFeatures(e,t,n,r){var s=this;return(0,p.Z)(function*(){const i=s._maxQuery;return!0===s._checkIfNeedToExpandKnownPage(e,i)?(yield s._expandPagedSet(e,i,0,0,r),s._getFeatures(e,t,n,r)):"success"})()}_getFilteredSet(e,t,n,r,s){var i=this;return(0,p.Z)(function*(){if(""!==e)return new b.Z([],[],!0,null);let l=null;const a={ordered:!1,nowhereclause:!1};if(yield i._ensureLoaded(),null!==n)for(let _=0;_<i._decodedStatsfield.length;_++)if(!0===(0,d.hq)(n,i._decodedStatsfield[_].tofieldname)){a.nowhereclause=!0,n=null;break}if(null!==r){a.ordered=!0;for(let _=0;_<i._decodedStatsfield.length;_++)if(!0===r.scanForField(i._decodedStatsfield[_].tofieldname)){r=null,a.ordered=!1;break}if(null!==r)for(const _ of i._decodedGroupbyfield)if(null===_.singlefield&&!0===r.scanForField(_.tofieldname)){r=null,a.ordered=!1;break}}if(!1!==i._candosimplegroupby&&(yield i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null))){let _=null;n&&(_=i._reformulateWhereClauseWithoutGroupByFields(n));let C=null;r&&(C=i._reformulateOrderClauseWithoutGroupByFields(r));const L=yield i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,_,C,i._internalObjectIdField);return i._checkCancelled(s),l=!0===a.nowhereclause?new b.Z(L._candidates.slice(0).concat(L._known.slice(0)),[],!0===a.ordered&&L._ordered,i._clonePageDefinition(L.pagesDefinition)):new b.Z(L._candidates.slice(0),L._known.slice(0),!0===a.ordered&&L._ordered,i._clonePageDefinition(L.pagesDefinition)),l}let c=i._parent;if(i._adaptedFields.length>0&&(c=new M.Xx({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===a.nowhereclause)l=new b.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new D.Z({parentfeatureset:c,orderbyclause:new A.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{let _=c;if(null!==n){let C=null;n&&(C=i._reformulateWhereClauseWithoutGroupByFields(n)),_=new Z.Z({parentfeatureset:_,whereclause:C})}l=new b.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new D.Z({parentfeatureset:_,orderbyclause:new A.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return l})()}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,d.bB)(e,t.tofieldname,(0,d.zR)(t.workingexpr,f.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,d.bB)(e,t.tofieldname,(0,d.zR)(t.expression,f.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const n of this._decodedGroupbyfield)n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,n){var r=this;return(0,p.Z)(function*(){return!0===r._checkIfNeedToExpandCandidatePage(e,r._maxQuery)?(yield r._expandPagedSet(e,r._maxQuery,0,0,n),r._refineSetBlock(e,t,n)):(r._checkCancelled(n),r._refineKnowns(e,t),e)})()}_expandPagedSet(e,t,n,r,s){return this._expandPagedSetFeatureSet(e,t,n,r,s)}_getPhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){if(!0===e.pagesDefinition.aggregatefeaturesetpagedefinition)return r._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]);const s=yield r._getAgregagtePhysicalPage(e,t,n);for(const i of s){const l={geometry:i.geometry,attributes:{}};for(const a of r._decodedGroupbyfield)l.attributes[a.tofieldname]=i.attributes[a.name];for(const a of r._decodedStatsfield)l.attributes[a.tofieldname]=i.attributes[a.field];r._featureCache[l.attributes[r.objectIdField]]=new R.Z(l)}return s.length})()}_sequentialGetPhysicalItem(e,t,n,r){return new Promise((s,i)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||0===t?s(r.length):this._nextAggregateItem(e,t,n,r,l=>{s(null===l?r.length:this._sequentialGetPhysicalItem(e,t-=1,n,r))},i)})}_nextAggregateItem(e,t,n,r,s,i){try{(0,G.W)(e.pagesDefinition.internal.iterator.next()).then(l=>{if(null===l)if(null!==e.pagesDefinition.internal.workingItem){const a=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(a),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(a.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,s(null)}else e.pagesDefinition.internal.fullyResolved=!0,s(null);else{const a=this._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:a};else{if(a!==e.pagesDefinition.internal.workingItem.id){const c=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(c),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(c.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:a},void s(c)}e.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(e,t,n,r,s,i)}},i)}catch(l){i(l)}}_calculateFieldStat(e,t,n){const r=[];for(let s=0;s<e.features.length;s++)if(null!==t.workingexpr){const i=t.workingexpr.calculateValue(e.features[s]);null!==i&&r.push(i)}else r.push(null);switch(t.typeofstat){case"MIN":n.attributes[t.tofieldname]=(0,O.tj)("min",r,-1);break;case"MAX":n.attributes[t.tofieldname]=(0,O.tj)("max",r,-1);break;case"SUM":n.attributes[t.tofieldname]=(0,O.tj)("sum",r,-1);break;case"COUNT":n.attributes[t.tofieldname]=r.length;break;case"VAR":n.attributes[t.tofieldname]=(0,O.tj)("var",r,-1);break;case"STDDEV":n.attributes[t.tofieldname]=(0,O.tj)("stddev",r,-1);break;case"AVG":n.attributes[t.tofieldname]=(0,O.tj)("avg",r,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const r of this._decodedGroupbyfield){const s=r.singlefield?e.features[0].attributes[r.singlefield]:r.expression.calculateValue(e.features[0]);t.attributes[r.tofieldname]=s}for(const r of this._decodedStatsfield)this._calculateFieldStat(e,r,t);const n=[];for(let r=0;r<this._decodedStatsfield.length;r++)n.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new R.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const n of this._decodedGroupbyfield){const r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null==r?":":":"+r.toString()}return(0,I.F)(t,I.M.String)}_stat(){return(0,p.Z)(function*(){return{calculated:!1}})()}getFeatureByObjectId(){return(0,p.Z)(function*(){return null})()}static registerAction(){g.Z._featuresetFunctions.groupby=function(e,t){return new S({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var w=h(3482),V=h(79429),N=h(22386),k=h(24263),B=h(91179),T=h(80415),U=h(82054),me=(h(26584),h(8314),h(63290),h(15283),h(2865)),we=(h(59318),h(85931),h(21726),h(16730),h(37053),h(20477)),ve=h(17253),ee=h(96854),De=(h(87183),h(67736),h(90463)),Ce=(h(29132),h(24865)),Fe=h(67010),Re=(h(93555),h(6871),h(98558)),Se=h(60776),be=h(6729);class se extends g.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,this._cachedDateMetaData={},e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return f.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(e){const t=this.urlQueryPath+","+(0,f.hd)(e.toJSON());return(0,I.F)(t,I.M.String)}loadImpl(){var e=this;return(0,p.Z)(function*(){return!0===e._layer.loaded?(e._initialiseFeatureSet(),e):(yield e._layer.load(),e._initialiseFeatureSet(),e)})()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const n of this._layer.outFields)if(n.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const n of this.fields)if("oid"===n.type)e.push(n),t.push(n.name);else for(const r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=f.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=f.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=f.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=f.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types}_isInFeatureSet(){return f.dj.InFeatureSet}_refineSetBlock(e){return(0,p.Z)(function*(){return e})()}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,p.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_runDatabaseProbe(e){var t=this;return(0,p.Z)(function*(){yield t._ensureLoaded();const n=new ee.Z;t.datesInUnknownTimezone&&(n.timeReferenceUnknownClient=!0),n.where=e.replace("OBJECTID",t._layer.objectIdField);try{return yield t._layer.queryObjectIds(n),!0}catch{return!1}})()}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){const t=this._layer?.capabilities?.query;return!e.outStatistics&&!0===t?.supportsFormatPBF&&!0===t?.supportsQuantizationEditMode}queryPBF(e){var t=this;return(0,p.Z)(function*(){e.quantizationParameters={mode:"edit"};const n=yield(0,we.qp)(t._layer.parsedUrl,e,new Re.J({}));return ve.Z.fromJSON((0,U.cn)(n.data)).unquantize()})()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const n="execute"===t?me.e:"executeForCount"===t?De.P:Ce.G,r="execute"===t&&this.pbfSupportedForQuery(e);let s=null;if(this.recentlyUsedQueries){const i=this.convertQueryToLruCacheKey(e);s=this.recentlyUsedQueries.getFromCache(i),null===s&&(s=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(i,s),s=s.catch(l=>{throw this.recentlyUsedQueries?.removeFromCache(i),l}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===s&&(s=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e)),s}_getFilteredSet(e,t,n,r,s){var i=this;return(0,p.Z)(function*(){const l=yield i.databaseType();if(i.isTable()&&t&&null!==e&&""!==e)return new b.Z([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,n,r,s);let a="",c=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(a=r.constructClause(),c=!0);const _=new ee.Z;i.datesInUnknownTimezone&&(_.timeReferenceUnknownClient=!0),_.where=null===n?null===t?"1=1":"":(0,d.zR)(n,l),i._requestStandardised&&(_.sqlFormat="standard"),_.spatialRelationship=i._makeRelationshipEnum(e),_.outSpatialReference=i.spatialReference,_.orderByFields=""!==a?a.split(","):null,_.geometry=null===t?null:t,_.relationParameter=i._makeRelationshipParam(e);let C=yield i.executeQuery(_,"executeForIds");return null===C&&(C=[]),i._checkCancelled(s),new b.Z([],C,c,null)})()}_expandPagedSet(e,t,n,r,s){return this._expandPagedSetFeatureSet(e,t,n,r,s)}_getFilteredSetUsingPaging(e,t,n,r,s){var i=this;return(0,p.Z)(function*(){let l="",a=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(l=r.constructClause(),a=!0);const c=yield i.databaseType();let _=null===n?null===t?"1=1":"":(0,d.zR)(n,c);i._layer.definitionExpression&&i._useDefinitionExpression&&(_=""!==_?"(("+i._layer.definitionExpression+") AND ("+_+"))":i._layer.definitionExpression);let C=i._maxQueryRate();const L=i._layer.capabilities?.query.maxRecordCount;null!=L&&L<C&&(C=L);let j=null;if(!0===i._pageJustIds)j=new b.Z([],["GETPAGES"],a,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:C,resultOffset:0,geometry:null===t?null:t,where:_,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let K=!0;!0===i._removeGeometry&&(K=!1);const J=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);j=new b.Z([],["GETPAGES"],a,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:J.join(","),resultRecordCount:C,resultOffset:0,geometry:null===t?null:t,where:_,orderByFields:l,returnGeometry:K,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return yield i._expandPagedSet(j,C,0,1,s),j})()}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){const s=e.pagesDefinition.internal.lastRetrieved,i=s,l=e.pagesDefinition.internal.lastPage,a=new ee.Z;r._requestStandardised&&(a.sqlFormat="standard"),r.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParameter=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastPage,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=r.spatialReference;const c=yield r.executeQuery(a,"execute");if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==l)return"done";const _=r._layer.objectIdField;for(let C=0;C<c.features.length;C++)e.pagesDefinition.internal.set[i+C]=c.features[C].attributes[_];if(!1===r._pageJustIds)for(let C=0;C<c.features.length;C++)r._featureCache[c.features[C].attributes[_]]=c.features[C];return(void 0===c.exceededTransferLimit&&c.features.length!==e.pagesDefinition.resultRecordCount||!1===c.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+c.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFeatures(e,t,n,r){var s=this;return(0,p.Z)(function*(){const i=[];if(-1!==t&&void 0===s._featureCache[t]&&i.push(t),!0===s._checkIfNeedToExpandKnownPage(e,s._maxProcessingRate()))return yield s._expandPagedSet(e,s._maxProcessingRate(),0,0,r),s._getFeatures(e,t,n,r);let l=0;for(let C=e._lastFetchedIndex;C<e._known.length;C++){if(e._lastFetchedIndex+=1,l++,void 0===s._featureCache[e._known[C]]){let L=!1;if(null!=s._layer._mode){const j=s._layer._mode;if(void 0!==j._featureMap[e._known[C]]){const K=j._featureMap[e._known[C]];null!==K&&(L=!0,s._featureCache[e._known[C]]=K)}}if(!1===L&&(e._known[C]!==t&&i.push(e._known[C]),i.length>=s._maxProcessingRate()-1))break}if(l>=n&&0===i.length)break}if(0===i.length)return"success";const a=new ee.Z;s._requestStandardised&&(a.sqlFormat="standard"),s.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0),a.objectIds=i,a.outFields=null!==s._overrideFields?s._overrideFields:s._fieldsIncludingObjectId(s._layer.outFields?s._layer.outFields:["*"]),a.returnGeometry=!0,!0===s._removeGeometry&&(a.returnGeometry=!1),a.outSpatialReference=s.spatialReference;const c=yield s.executeQuery(a,"execute");if(s._checkCancelled(r),void 0!==c.error)throw new o.EN(o.H9.RequestFailed,{reason:c.error});const _=s._layer.objectIdField;for(let C=0;C<c.features.length;C++)s._featureCache[c.features[C].attributes[_]]=c.features[C];return"success"})()}_getDistinctPages(e,t,n,r,s,i,l,a,c){var _=this;return(0,p.Z)(function*(){yield _._ensureLoaded();const C=yield _.databaseType();let L=n.parseTree.column;const j=_._layer.fields??[];for(let Q=0;Q<j.length;Q++)if(j[Q].name.toLowerCase()===L.toLowerCase()){L=j[Q].name;break}const K=new ee.Z;_._requestStandardised&&(K.sqlFormat="standard"),_.datesInUnknownTimezone&&(K.timeReferenceUnknownClient=!0);let J=null===i?null===s?"1=1":"":(0,d.zR)(i,C);_._layer.definitionExpression&&_._useDefinitionExpression&&(J=""!==J?"(("+_._layer.definitionExpression+") AND ("+J+"))":_._layer.definitionExpression),K.where=J,K.spatialRelationship=_._makeRelationshipEnum(r),K.relationParameter=_._makeRelationshipParam(r),K.geometry=null===s?null:s,K.returnDistinctValues=!0,K.returnGeometry=!1,K.outFields=[L];const H=yield _.executeQuery(K,"execute");if(_._checkCancelled(c),!H.hasOwnProperty("features"))throw new o.EN(o.H9.InvalidStatResponse);let $=!1;for(let Q=0;Q<j.length;Q++)if(j[Q].name===L){"date"===j[Q].type&&($=!0);break}for(let Q=0;Q<H.features.length;Q++){if($){const ne=H.features[Q].attributes[L];a.push(null!==ne?new Date(ne):ne)}else a.push(H.features[Q].attributes[L]);if(a.length>=l)break}return 0===H.features.length?a:H.features.length===_._layer.capabilities?.query.maxRecordCount&&a.length<l?{calculated:!0,result:yield _._getDistinctPages(e+H.features.length,t,n,r,s,i,l,a,c)}:a})()}_distinctStat(e,t,n,r,s,i,l){var a=this;return(0,p.Z)(function*(){return{calculated:!0,result:yield a._getDistinctPages(0,e,t,n,r,s,i,[],l)}})()}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType}_countstat(e,t,n,r){var s=this;return(0,p.Z)(function*(){const i=yield s.databaseType(),l=new ee.Z;if(s._requestStandardised&&(l.sqlFormat="standard"),s.isTable()&&n&&null!==t&&""!==t)return{calculated:!0,result:0};let a=null===r?null===n?"1=1":"":(0,d.zR)(r,i);return s._layer.definitionExpression&&s._useDefinitionExpression&&(a=""!==a?"(("+s._layer.definitionExpression+") AND ("+a+"))":s._layer.definitionExpression),l.where=a,s.datesInUnknownTimezone&&(l.timeReferenceUnknownClient=!0),l.where=a,l.spatialRelationship=s._makeRelationshipEnum(t),l.relationParameter=s._makeRelationshipParam(t),l.geometry=null===n?null:n,l.returnGeometry=!1,{calculated:!0,result:yield s.executeQuery(l,"executeForCount")}})()}_stats(e,t,n,r,s,i,l){var a=this;return(0,p.Z)(function*(){yield a._ensureLoaded();const c=a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsSqlExpression,_=a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsStatistics,C=a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsDistinct;if("count"===e)return C?a._countstat(e,n,r,s):{calculated:!1};if(!1===_||!1===(0,d.y5)(t)&&!1===c||!1===t.isStandardized)return""!==n||null!==s?{calculated:!1}:a._manualStat(e,t,i,l);if("distinct"===e)return!1===C?""!==n||null!==s?{calculated:!1}:a._manualStat(e,t,i,l):a._distinctStat(e,t,n,r,s,i,l);const L=yield a.databaseType();if(a.isTable()&&r&&null!==n&&""!==n)return{calculated:!0,result:null};const j=new ee.Z;a._requestStandardised&&(j.sqlFormat="standard");let K=null===s?null===r?"1=1":"":(0,d.zR)(s,L);a._layer.definitionExpression&&a._useDefinitionExpression&&(K=""!==K?"(("+a._layer.definitionExpression+") AND ("+K+"))":a._layer.definitionExpression),j.where=K,j.spatialRelationship=a._makeRelationshipEnum(n),j.relationParameter=a._makeRelationshipParam(n),j.geometry=null===r?null:r,a.datesInUnknownTimezone&&(j.timeReferenceUnknownClient=!0);const J=new Se.Z;J.statisticType=(0,O.g3)(e),J.onStatisticField=(0,d.zR)(t,L),J.outStatisticFieldName="ARCADE_STAT_RESULT",j.returnGeometry=!1;let H="ARCADE_STAT_RESULT";j.outStatistics=[J];const $=yield a.executeQuery(j,"execute");if(!$.hasOwnProperty("features")||0===$.features.length)throw new o.EN(o.H9.InvalidStatResponse);let Q=!1;const ne=$.fields??[];for(let te=0;te<ne.length;te++)if("ARCADE_STAT_RESULT"===ne[te].name.toUpperCase()){H=ne[te].name,"date"===ne[te].type&&(Q=!0);break}if(Q){let te=$.features[0].attributes[H];return null!==te&&(te=new Date($.features[0].attributes[H])),{calculated:!0,result:te}}return{calculated:!0,result:$.features[0].attributes[H]}})()}_stat(e,t,n,r,s,i,l){return this._stats(e,t,n,r,s,i,l)}_canDoAggregates(e,t){var n=this;return(0,p.Z)(function*(){yield n._ensureLoaded();let r=!1;const s=n._layer.capabilities?.query,i=!0===s?.supportsSqlExpression;if(null!=s&&!0===s.supportsStatistics&&!0===s.supportsOrderBy&&(r=!0),r)for(let l=0;l<t.length-1;l++)(!1===t[l].workingexpr?.isStandardized||!1===(0,d.y5)(t[l].workingexpr)&&!1===i)&&(r=!1);return!1!==r})()}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,n,r,s,i,l){var a=this;return(0,p.Z)(function*(){yield a._ensureLoaded();const c=yield a.databaseType();let _="",C=!1,L=!1;null!==i&&a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsOrderBy&&(_=i.constructClause(),L=!0),a._layer.capabilities&&a._layer.capabilities.query&&!1===a._layer.capabilities.query.supportsPagination&&(L=!1,C=!0,_=a._layer.objectIdField);const j=[];for(let $=0;$<t.length;$++){const Q=new Se.Z;Q.onStatisticField=null!==t[$].workingexpr?(0,d.zR)(t[$].workingexpr,c):"",Q.outStatisticFieldName=t[$].field,Q.statisticType=t[$].toStatisticsName(),j.push(Q)}""===_&&(_=e.join(","));let K=a._maxQueryRate();const J=a._layer.capabilities?.query.maxRecordCount;null!=J&&J<K&&(K=J);let H=null===s?null===r?"1=1":"":(0,d.zR)(s,c);return a._layer.definitionExpression&&a._useDefinitionExpression&&(H=""!==H?"(("+a._layer.definitionExpression+") AND ("+H+"))":a._layer.definitionExpression),new b.Z([],["GETPAGES"],L,{groupbypage:!0,spatialRel:a._makeRelationshipEnum(n),relationParam:a._makeRelationshipParam(n),outFields:["*"],useOIDpagination:C,generatedOid:l,resultRecordCount:K,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:j,geometry:null===r?null:r,where:H,orderByFields:_,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})()}_getAgregagtePhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){let s=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(s=""!==s?"("+s+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const i=e.pagesDefinition.internal.lastRetrieved,l=i,a=e.pagesDefinition.internal.lastPage,c=new ee.Z;if(r._requestStandardised&&(c.sqlFormat="standard"),c.where=s,c.spatialRelationship=e.pagesDefinition.spatialRel,c.relationParameter=e.pagesDefinition.relationParam,c.outFields=e.pagesDefinition.outFields,c.outStatistics=e.pagesDefinition.outStatistics,c.geometry=e.pagesDefinition.geometry,c.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,c.num=e.pagesDefinition.resultRecordCount,c.start=e.pagesDefinition.internal.lastPage,c.returnGeometry=e.pagesDefinition.returnGeometry,r.datesInUnknownTimezone&&(c.timeReferenceUnknownClient=!0),c.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,r.isTable()&&c.geometry&&c.spatialRelationship)return[];const _=yield r.executeQuery(c,"execute");if(r._checkCancelled(n),!_.hasOwnProperty("features"))throw new o.EN(o.H9.InvalidStatResponse);const C=[];if(e.pagesDefinition.internal.lastPage!==a)return[];for(let L=0;L<_.features.length;L++)e.pagesDefinition.internal.set[l+L]=_.features[L].attributes[e.pagesDefinition.generatedOid];for(let L=0;L<_.features.length;L++)C.push(new R.Z({attributes:_.features[L].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===_.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=_.features[_.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===_.exceededTransferLimit&&_.features.length!==e.pagesDefinition.resultRecordCount||!1===_.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+_.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,C})()}static create(e,t,n,r,s){const i=new T.default({url:e,outFields:null===t?["*"]:t});return new se({layer:i,spatialReference:n,lrucache:r,interceptor:s})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,f.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,n,r,s){var i=this;return(0,p.Z)(function*(){const l=i._layer.capabilities;if(l?.data.supportsAttachment&&l?.operations.supportsQueryAttachments){const a={objectIds:[e],returnMetadata:s};(t&&t>0||n&&n>0)&&(a.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(a.attachmentTypes=r),i.featureSetQueryInterceptor&&i.featureSetQueryInterceptor.preLayerQueryCallback({layer:i._layer,query:a,method:"attachments"});const c=yield i._layer.queryAttachments(a),_=[];return c&&c[e]&&c[e].forEach(C=>{const L=i._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+C.id.toString();let j=null;s&&C.exifInfo&&(j=be.Z.convertJsonToArcade(C.exifInfo,"system",!0)),_.push(new N.Z(C.id,C.name,C.contentType,C.size,L,j))}),_}return[]})()}queryRelatedFeatures(e){var t=this;return(0,p.Z)(function*(){const n={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields?.join(","),returnGeometry:e.returnGeometry.toString()};null!=e.resultOffset&&(n.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(n.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),e.objectIds&&e.objectIds.length>0&&(n.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(n.outSR=JSON.stringify(e.outSpatialReference.toJSON())),t.featureSetQueryInterceptor&&t.featureSetQueryInterceptor.preRequestCallback({layer:t._layer,queryPayload:n,method:"relatedrecords",url:t._layer.parsedUrl.path+"/queryRelatedRecords"});const r=yield(0,q.default)(t._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:n});if(r.data){const s={},i=r.data;if(i&&i.relatedRecordGroups){const l=i.spatialReference;for(const a of i.relatedRecordGroups){const c=a.objectId,_=[];for(const C of a.relatedRecords){C.geometry&&(C.geometry.spatialReference=l);const L=new R.Z({geometry:C.geometry?(0,B.im)(C.geometry):null,attributes:C.attributes});_.push(L)}s[c]={features:_,exceededTransferLimit:!0===i.exceededTransferLimit}}}return s}throw new o.EN(o.H9.InvalidRequest)})()}getFeatureByObjectId(e,t){var n=this;return(0,p.Z)(function*(){const r=new ee.Z;r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=n.spatialReference,r.where=n.objectIdField+"="+e.toString(),n.datesInUnknownTimezone&&(r.timeReferenceUnknownClient=!0),n.featureSetQueryInterceptor&&n.featureSetQueryInterceptor.preLayerQueryCallback({layer:n._layer,query:r,method:"execute"});const s=yield(0,me.e)(n._layer.parsedUrl.path,r);return 1===s.features.length?s.features[0]:null})()}getIdentityUser(){var e=this;return(0,p.Z)(function*(){yield e.load();const t=k.id?.findCredential(e._layer.url);return t?t.userId:null})()}getOwningSystemUrl(){var e=this;return(0,p.Z)(function*(){yield e.load();const t=k.id?.findServerInfo(e._layer.url);if(t)return t.owningSystemUrl;let n=e._layer.url;const r=n.toLowerCase().indexOf("/rest/services");if(n=r>-1?n.substring(0,r):n,n){n+="/rest/info";try{const s=yield(0,q.default)(n,{query:{f:"json"}});let i="";return s.data&&s.data.owningSystemUrl&&(i=s.data.owningSystemUrl),i}catch{return""}}return""})()}getDataSourceFeatureSet(){const e=new se({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return e._useDefinitionExpression=!1,e}get preferredTimeReference(){return void 0===this._cachedDateMetaData.preferredTimeReference&&(this._cachedDateMetaData.preferredTimeReference=this._layer?.preferredTimeReference?.toJSON()??null),this._cachedDateMetaData.preferredTimeReference}get dateFieldsTimeReference(){return void 0===this._cachedDateMetaData.dateFieldsTimeReference&&(this._cachedDateMetaData.dateFieldsTimeReference=this._layer?.dateFieldsTimeReference?.toJSON()??null),this._cachedDateMetaData.dateFieldsTimeReference}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone}get editFieldsInfo(){return void 0===this._cachedDateMetaData.editFieldsInfo&&(this._cachedDateMetaData.editFieldsInfo=this._layer?.editFieldsInfo?.toJSON()??null),this._cachedDateMetaData.editFieldsInfo}get timeInfo(){return void 0===this._cachedDateMetaData.timeInfo&&(this._cachedDateMetaData.timeInfo=this._layer?.timeInfo?.toJSON()??null),this._cachedDateMetaData.timeInfo}}var Te=h(16776);class Ee extends g.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this._relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return f.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var e=this;return(0,p.Z)(function*(){return yield Promise.all([e._layer.load(),e._relatedLayer?.load()]),e._initialiseFeatureSet(),e})()}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],n=[];for(const r of this.fields)if("oid"===r.type)t.push(r),n.push(r.name);else for(const s of this._overrideFields)if(s.toLowerCase()===r.name.toLowerCase()){t.push(r),n.push(r.name);break}this.fields=t,this._overrideFields=n}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types}databaseType(){var e=this;return(0,p.Z)(function*(){return yield e._relatedLayer.databaseType(),e._databaseType=e._relatedLayer._databaseType,e._databaseType})()}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return f.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,p.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_changeFeature(e){const t={};for(const n of this.fields)t[n.name]=e.attributes[n.name];return new R.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,n,r,s){var i=this;return(0,p.Z)(function*(){if(yield i.databaseType(),i.isTable()&&t&&null!==e&&""!==e)return new b.Z([],[],!0,null);const l=i._layer.nativeCapabilities();if(!1===l.canQueryRelated)return new b.Z([],[],!0,null);if(l.capabilities?.queryRelated&&l.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,n,r,s);let a="",c=!1;null!==r&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(a=r.constructClause(),c=!0);const _=new Fe.default;_.objectIds=[i._findObjectId];const C=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._relatedLayer.fields?i._relatedLayer.fields.map(Q=>Q.name):["*"]);_.outFields=C,_.relationshipId=i.relationship.id,_.where="1=1";let L=!0;!0===i._removeGeometry&&(L=!1),_.returnGeometry=L,i._requestStandardised&&(_.sqlFormat="standard"),_.outSpatialReference=i.spatialReference,_.orderByFields=""!==a?a.split(","):null;const j=yield l.source.queryRelatedFeatures(_);i._checkCancelled(s);const K=j[i._findObjectId]?j[i._findObjectId].features:[],J=[];for(let Q=0;Q<K.length;Q++)i._featureCache[K[Q].attributes[i._relatedLayer.objectIdField]]=K[Q],J.push(K[Q].attributes[i._relatedLayer.objectIdField]);const H=t&&null!==e&&""!==e,$=null!=n;return new b.Z(H||$?J:[],H||$?[]:J,c,null)})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,n,r,s){var i=this;return(0,p.Z)(function*(){let l="",a=!1;const c=i._layer.nativeCapabilities();null!==r&&c&&c.capabilities?.queryRelated&&!0===c.capabilities.queryRelated.supportsOrderBy&&(l=r.constructClause(),a=!0),yield i.databaseType();let C=i._maxQueryRate();const L=c.capabilities?.query.maxRecordCount;null!=L&&L<C&&(C=L);const j=t&&null!==e&&""!==e,K=null!=n;let J=null,H=!0;!0===i._removeGeometry&&(H=!1);const $=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._relatedLayer.fields?i._relatedLayer.fields.map(Q=>Q.name):["*"]);return J=new b.Z(j||K?["GETPAGES"]:[],j||K?[]:["GETPAGES"],a,{outFields:$.join(","),resultRecordCount:C,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:l,returnGeometry:H,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),yield i._expandPagedSet(J,C,0,0,s),J})()}_expandPagedSet(e,t,n,r,s){return this._expandPagedSetFeatureSet(e,t,n,r,s)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,p.Z)(function*(){const s=e.pagesDefinition.internal.lastRetrieved,i=s,l=e.pagesDefinition.internal.lastPage,a=r._layer.nativeCapabilities(),c=new Fe.default;!0===r._requestStandardised&&(c.sqlFormat="standard"),c.relationshipId=r.relationship.id,c.objectIds=e.pagesDefinition.objectIds,c.resultOffset=e.pagesDefinition.internal.lastPage,c.resultRecordCount=e.pagesDefinition.resultRecordCount,c.outFields=e.pagesDefinition.outFields.split(","),c.where=e.pagesDefinition.where,c.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,c.returnGeometry=e.pagesDefinition.returnGeometry,c.outSpatialReference=r.spatialReference;const _=yield a.source.queryRelatedFeatures(c);if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==l)return 0;const C=_[r._findObjectId]?_[r._findObjectId].features:[];for(let j=0;j<C.length;j++)e.pagesDefinition.internal.set[i+j]=C[j].attributes[r._relatedLayer.objectIdField];for(let j=0;j<C.length;j++)r._featureCache[C[j].attributes[r._relatedLayer.objectIdField]]=C[j];return C.length!==e.pagesDefinition.resultRecordCount&&(!_[r._findObjectId]||!1===_[r._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+C.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,C.length})()}_getFeatures(e,t,n,r){var s=this;return(0,p.Z)(function*(){const i=[];-1!==t&&void 0===s._featureCache[t]&&i.push(t);const l=s._maxQueryRate();if(!0===s._checkIfNeedToExpandKnownPage(e,l))return yield s._expandPagedSet(e,l,0,0,r),s._getFeatures(e,t,n,r);let a=0;for(let c=e._lastFetchedIndex;c<e._known.length&&(a++,a<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[c]&&void 0===s._featureCache[e._known[c]]&&(e._known[c]!==t&&i.push(e._known[c]),i.length>n)))&&!(a>=n&&0===i.length);c++);if(0===i.length)return"success";throw new o.EN(o.H9.MissingFeatures)})()}_refineSetBlock(e,t,n){return(0,p.Z)(function*(){return e})()}_stat(e,t,n,r,s,i,l){return(0,p.Z)(function*(){return{calculated:!1}})()}get gdbVersion(){return this._relatedLayer.gdbVersion}_canDoAggregates(e,t,n,r,s){return(0,p.Z)(function*(){return!1})()}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,s){return this._relatedLayer.queryAttachments(e,t,n,r,s)}getFeatureByObjectId(e,t){return this._relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeReference(){return this._relatedLayer?.preferredTimeReference??null}get dateFieldsTimeReference(){return this._relatedLayer?.dateFieldsTimeReference??null}get datesInUnknownTimezone(){return this._relatedLayer?.datesInUnknownTimezone}get editFieldsInfo(){return this._relatedLayer?.editFieldsInfo??null}get timeInfo(){return this._relatedLayer?.timeInfo??null}}var z=h(53791),xe=h(55463);function Oe(){null===z.Z.applicationCache&&(z.Z.applicationCache=new z.Z)}function le(E,e){return oe.apply(this,arguments)}function oe(){return(oe=(0,p.Z)(function*(E,e){if(z.Z.applicationCache){const t=z.Z.applicationCache.getLayerInfo(E);if(t){const s=yield t;return new T.default({url:E,outFields:e,sourceJSON:s})}const n=new T.default({url:E,outFields:e}),r=(0,p.Z)(function*(){return yield n.load(),n.sourceJSON})();if(z.Z.applicationCache){z.Z.applicationCache.setLayerInfo(E,r);try{return yield r,n}catch(s){throw z.Z.applicationCache.clearLayerInfo(E),s}}return yield r,n}return new T.default({url:E,outFields:e})})).apply(this,arguments)}function ue(E,e,t,n,r){return de.apply(this,arguments)}function de(){return(de=(0,p.Z)(function*(E,e,t,n,r,s=null){return re(yield le(E,["*"]),e,t,n,r,s)})).apply(this,arguments)}function re(E,e=null,t=null,n=!0,r=null,s=null){const i={layer:E,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:s};return!0===E._hasMemorySource()?new Te.Z(i):new se(i)}function ce(){return(ce=(0,p.Z)(function*(E){if(null!==z.Z.applicationCache){const t=z.Z.applicationCache.getLayerInfo(E);if(null!==t)return t}const e=(0,p.Z)(function*(){const t=yield(0,q.default)(E,{responseType:"json",query:{f:"json"}});return t.data?t.data:null})();if(null!==z.Z.applicationCache){z.Z.applicationCache.setLayerInfo(E,e);try{return yield e}catch(t){throw z.Z.applicationCache.clearLayerInfo(E),t}}return e})).apply(this,arguments)}function he(){return(he=(0,p.Z)(function*(E,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+E;if(null!==z.Z.applicationCache){const r=z.Z.applicationCache.getLayerInfo(t);if(null!==r)return r}const n=(0,p.Z)(function*(){const r=yield(0,q.default)(E+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(r.data){const s=r.data;if(s.layerDataElements&&s.layerDataElements[0])return s.layerDataElements[0]}throw new o.EN(o.H9.DataElementsNotFound)})();if(null!==z.Z.applicationCache){z.Z.applicationCache.setLayerInfo(t,n);try{return yield n}catch(r){throw z.Z.applicationCache.clearLayerInfo(t),r}}return n})).apply(this,arguments)}function Ie(E){return fe.apply(this,arguments)}function fe(){return(fe=(0,p.Z)(function*(E){if(null!==z.Z.applicationCache){const t=z.Z.applicationCache.getLayerInfo(E);if(null!==t)return t}const e=(0,p.Z)(function*(){const t=yield(0,q.default)(E,{responseType:"json",query:{f:"json"}});if(t.data){const n=t.data;return n.layers||(n.layers=[]),n.tables||(n.tables=[]),n}return{layers:[],tables:[]}})();if(null!==z.Z.applicationCache){z.Z.applicationCache.setLayerInfo(E,e);try{return yield e}catch(t){throw z.Z.applicationCache.clearLayerInfo(E),t}}return e})).apply(this,arguments)}function Le(E,e){return _e.apply(this,arguments)}function _e(){return _e=(0,p.Z)(function*(E,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},n=yield Ie(E);if(t.metadata=n,n.controllerDatasetLayers&&null!=n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const i of n.layers)t.layerNameLkp[i.id]=i.name;if(n.tables)for(const i of n.tables)t.layerNameLkp[i.id]=i.name;const r=n.controllerDatasetLayers.utilityNetworkLayerId;t.networkId=r;const s=yield function Ne(E,e){return he.apply(this,arguments)}(E,r);if(s){t.queryelem=s,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const l of t.queryelem.dataElement.domainNetworks){for(const a of l.edgeSources?l.edgeSources:[]){const c={layerId:a.layerId,sourceId:a.sourceId,className:t.layerNameLkp[a.layerId]?t.layerNameLkp[a.layerId]:null};c.className&&(t.lkp[c.className]=c)}for(const a of l.junctionSources?l.junctionSources:[]){const c={layerId:a.layerId,sourceId:a.sourceId,className:t.layerNameLkp[a.layerId]?t.layerNameLkp[a.layerId]:null};c.className&&(t.lkp[c.className]=c)}}if(t.queryelem.dataElement.terminalConfigurations)for(const l of t.queryelem.dataElement.terminalConfigurations)for(const a of l.terminals)t.terminals.push({terminalId:a.terminalId,terminalName:a.terminalName});const i=yield function Pe(E){return ce.apply(this,arguments)}(E+"/"+r);if(i.systemLayers&&null!=i.systemLayers.associationsTableId){const l=[];t.unVersion>=4&&(l.push("STATUS"),l.push("PERCENTALONG"));let a=yield ue(E+"/"+i.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...l],!1,null,null);return yield a.load(),t.unVersion>=4&&(a=a.filter(v.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",a.getFieldsIndex())),yield a.load()),{lkp:t.lkp,associations:a,unVersion:t.unVersion,terminals:t.terminals}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}),_e.apply(this,arguments)}function Ze(E,e,t){return pe.apply(this,arguments)}function pe(){return(pe=(0,p.Z)(function*(E,e,t,n=null,r=null,s=!0,i=null,l=null){let a=E.serviceUrl();if(!a)return null;a="/"===a.charAt(a.length-1)?a+e.relatedTableId.toString():a+"/"+e.relatedTableId.toString();const c=yield ue(a,n,r,s,i,l);return new Ee({layer:E,relatedLayer:c,relationship:e,objectId:t,spatialReference:n,outFields:r,includeGeometry:s,lrucache:i,interceptor:l})})).apply(this,arguments)}Z.Z.registerAction(),S.registerAction(),D.Z.registerAction(),w.Z.registerAction(),V.Z.registerAction();class Ae extends X.Z{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overridespref=t,this._lrucache=n,this._interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){const r=re(e,this._overridespref,null===n?["*"]:n,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}featureSetByName(e,t=!0,n=null){var r=this;return(0,p.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetByName(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const a=r._instantLayers[l];if(a.opitem.title===e&&a.includeGeometry===t&&a.outFields===s)return r._instantLayers[l].featureset}const i=r._map.allLayers.find(l=>l instanceof T.default&&l.title===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const l=r._map.tables.find(a=>!!(a.title&&a.title===e||a.title&&a.title===e));if(l){if(l instanceof T.default)return r._makeAndAddFeatureSet(l,t,n);if(!l._materializedTable){const a=l.outFields?l:{...l,outFields:["*"]};l._materializedTable=new T.default(a)}return yield l._materializedTable.load(),r._makeAndAddFeatureSet(l._materializedTable,t,n)}}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,p.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetById(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const a=r._instantLayers[l];if(a.opitem.id===e&&a.includeGeometry===t&&a.outFields===s)return r._instantLayers[l].featureset}const i=r._map.allLayers.find(l=>l instanceof T.default&&l.id===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const l=r._map.tables.find(a=>a.id===e);if(l){if(l instanceof T.default)return r._makeAndAddFeatureSet(l,t,n);if(!l._materializedTable){const a={...l,outFields:["*"]};l._materializedTable=new T.default(a)}return yield l._materializedTable.load(),r._makeAndAddFeatureSet(l._materializedTable,t,n)}}return null})()}}class ye extends X.Z{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overridespref=t,this._lrucache=n,this._interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){const r=re(e,this._overridespref,null===n?["*"]:n,t,this._lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}_loadMetaData(){var e=this;return(0,p.Z)(function*(){const t=yield Ie(e._url);return e.metadata=t,t})()}load(){return this._loadMetaData()}clone(){return new ye(this._url,this._overridespref,this._lrucache,this._interceptor)}featureSetByName(e,t=!0,n=null){var r=this;return(0,p.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);for(let a=0;a<r._instantLayers.length;a++){const c=r._instantLayers[a];if(c.opitem.title===e&&c.includeGeometry===t&&c.outFields===s)return r._instantLayers[a].featureset}const i=yield r._loadMetaData();let l=null;for(const a of i.layers?i.layers:[])a.name===e&&(l=a);if(!l)for(const a of i.tables?i.tables:[])a.name===e&&(l=a);if(l){const a=yield le(r._url+"/"+l.id,["*"]);return r._makeAndAddFeatureSet(a,t,n)}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,p.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const s=JSON.stringify(n);e=null!=e?e.toString():"";for(let a=0;a<r._instantLayers.length;a++){const c=r._instantLayers[a];if(c.opitem.id===e&&c.includeGeometry===t&&c.outFields===s)return r._instantLayers[a].featureset}const i=yield r._loadMetaData();let l=null;for(const a of i.layers?i.layers:[])null!=a.id&&a.id.toString()===e&&(l=a);if(!l)for(const a of i.tables?i.tables:[])null!=a.id&&a.id.toString()===e&&(l=a);if(l){const a=yield le(r._url+"/"+l.id,["*"]);return r._makeAndAddFeatureSet(a,t,n)}return null})()}}function je(E,e,t=null,n=null){return new Ae(E,e,t,n)}function ke(E,e,t=null,n=null){return new ye(E,e,t,n)}function Ue(E,e,t,n,r){if(null===E)return null;if(E instanceof T.default){switch(e){case"datasource":return re(E,r,E.outFields,!0,t,n).getDataSourceFeatureSet();case"parent":case"root":return re(E,r,E.outFields,!0,t,n)}return null}if(E instanceof g.Z)switch(e){case"datasource":return E.getDataSourceFeatureSet();case"parent":return E;case"root":return E.getRootFeatureSet()}return null}function Be(E,e,t,n,r,s,i){return ge.apply(this,arguments)}function ge(){return(ge=(0,p.Z)(function*(E,e,t,n,r,s,i,l=null){if(z.Z.applicationCache){const c=z.Z.applicationCache.getLayerInfo(E+":"+s.url);if(c){const _=yield c;return re(new T.default({url:(0,f.US)(_.url)+"/"+e,outFields:["*"]}),t,n,r,i,l)}}const a=new xe.default({id:E,portal:s}).load();z.Z.applicationCache&&z.Z.applicationCache.setLayerInfo(E+":"+s.url,a);try{const c=yield a;return re(new T.default({url:(0,f.US)(c.url??"")+"/"+e,outFields:["*"]}),t,n,r,i,l)}catch(c){throw z.Z.applicationCache&&z.Z.applicationCache.clearLayerInfo(E+":"+s.url),c}})).apply(this,arguments)}},52724:(ie,Y,h)=>{h.d(Y,{$X:()=>O,QP:()=>o,TO:()=>v,Xx:()=>P,yN:()=>x});var p=h(15861),q=h(88879),X=h(91365),Z=h(27187),R=h(47982),G=h(49086),M=h(91510),D=h(77132),g=h(83947),b=h(62208),A=h(10410),f=h(65234);class d{constructor(y){this.field=y,this.sqlRewritable=!1}postInitialization(y,u){}}class O extends d{constructor(y){super(y),this.sqlRewritable=!0}extractValue(y){return y.attributes[this.field.name]}rewriteSql(y){return{rewritten:this.sqlRewritable,where:y}}}class o extends d{constructor(y,u,m){super((0,D.JW)(y)),this.originalField=y,this.sqlRewritable=!0,this.field.name=u,this.field.alias=m}rewriteSql(y,u){return{rewritten:this.sqlRewritable,where:(0,g.bB)(y,this.field.name,this.originalField.name,u.getFieldsIndex())}}extractValue(y){return y.attributes[this.originalField.name]}}let v=(()=>{class I extends d{constructor(u,m,F){super(u),this.codefield=m,this.lkp=F,this.reverseLkp={};for(const S in F)this.reverseLkp[F[S]]=S;this.sqlRewritable=!0}rewriteSql(u,m){const F=this.evaluateNodeToWhereClause(u.parseTree,D.Bj.Standardised,this.field.name,this.codefield instanceof A.WhereClause?(0,g.zR)(this.codefield,D.Bj.Standardised):this.codefield,u.parameters);return F.includes(I.BADNESS)?{rewritten:!1,where:u}:{rewritten:this.sqlRewritable,where:A.WhereClause.create(F,(0,b.s3)(m._parent).getFieldsIndex())}}evaluateNodeToWhereClause(u,m,F=null,S=null,w){let V,N,k,B;switch(u.type){case"interval":return(0,g.TE)(this.evaluateNodeToWhereClause(u.value,m,F,S,w),u.qualifier,u.op);case"case-expression":{let T=" CASE ";"simple"===u.format&&(T+=this.evaluateNodeToWhereClause(u.operand,m,F,I.BADNESS,w));for(let U=0;U<u.clauses.length;U++)T+=" WHEN "+this.evaluateNodeToWhereClause(u.clauses[U].operand,m,F,I.BADNESS,w)+" THEN "+this.evaluateNodeToWhereClause(u.clauses[U].value,m,F,I.BADNESS,w);return null!==u.else&&(T+=" ELSE "+this.evaluateNodeToWhereClause(u.else,m,F,I.BADNESS,w)),T+=" END ",T}case"parameter":{const T=w[u.value.toLowerCase()];if("string"==typeof T)return"'"+T.toString().replace(/'/g,"''")+"'";if(T instanceof Date)return(0,g.oX)(T,m,null);if(T instanceof X.iG)return(0,g.mA)(T,m,null);if(T instanceof Array){const U=[];for(let W=0;W<T.length;W++)"string"==typeof T[W]?U.push("'"+T[W].toString().replace(/'/g,"''")+"'"):T[W]instanceof Date?U.push((0,g.oX)(T[W],m,null)):U.push(T[W]instanceof X.iG?(0,g.mA)(T[W],m,null):T[W].toString());return U}return T.toString()}case"expression-list":N=[];for(const T of u.value)N.push(this.evaluateNodeToWhereClause(T,m,F,S,w));return N;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(u.expr,m,F,I.BADNESS,w)+" ) ";case"binary-expression":switch(u.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" AND "+this.evaluateNodeToWhereClause(u.right,m,F,S,w)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" OR "+this.evaluateNodeToWhereClause(u.right,m,F,S,w)+") ";case"IS":if("null"!==u.right.type)throw new R.eS(R.f.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" IS NULL )";case"ISNOT":if("null"!==u.right.type)throw new R.eS(R.f.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" IS NOT NULL )";case"IN":if(V=[],"expression-list"===u.right.type){if("column-reference"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const T=[];let U=!0;for(const W of u.right.value){if("string"!==W.type){U=!1;break}if(void 0===this.lkp[W.value]){U=!1;break}T.push(this.lkp[W.value].toString())}if(U)return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" IN ("+T.join(",")+")) "}return V=this.evaluateNodeToWhereClause(u.right,m,F,S,w)," ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" IN ("+V.join(",")+")) "}return B=this.evaluateNodeToWhereClause(u.right,m,F,S,w),B instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" IN ("+B+")) ";case"NOT IN":if(V=[],"expression-list"===u.right.type){if("column-reference"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const T=[];let U=!0;for(const W of u.right.value){if("string"!==W.type){U=!1;break}if(void 0===this.lkp[W.value]){U=!1;break}T.push(this.lkp[W.value].toString())}if(U)return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" NOT IN ("+T.join(",")+")) "}return V=this.evaluateNodeToWhereClause(u.right,m,F,S,w)," ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" NOT IN ("+V.join(",")+")) "}return B=this.evaluateNodeToWhereClause(u.right,m,F,S,w),B instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" NOT IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,w)+" NOT IN ("+B+")) ";case"BETWEEN":return k=this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)," ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" BETWEEN "+k[0]+" AND "+k[1]+" ) ";case"NOTBETWEEN":return k=this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)," ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" NOT BETWEEN "+k[0]+" AND "+k[1]+" ) ";case"LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)+") ";case"NOT LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)+") ";case"<>":case"=":if("column-reference"===u.left.type&&"string"===u.right.type){if(u.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[u.right.value.toString()])return" ("+S+" "+u.operator+" "+this.lkp[u.right.value.toString()].toString()+") "}else if("column-reference"===u.right.type&&"string"===u.left.type&&u.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[u.right.value.toString()].toString()+" "+u.operator+" "+S+") ";return" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,w)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,w)+") "}case"null":return"null";case"boolean":return!0===u.value?"1":"0";case"string":return"'"+u.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,g.oX)(u.value,m,null);case"number":return u.value.toString();case"current-time":return(0,g.vR)("date"===u.mode,m);case"column-reference":return F&&F.toLowerCase()===u.column.toLowerCase()?"("+S+")":u.column;case"data-type":return u.value;case"function":{const T=this.evaluateNodeToWhereClause(u.args,m,F,I.BADNESS,w);return(0,g.fz)(u.name,T,m)}}throw new R.eS(R.f.UnsupportedSyntax,{node:u.type})}extractValue(u){return this.codefield instanceof A.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(u)]:this.reverseLkp[u.attributes[this.codefield]]}}return I.BADNESS="_!!!_BAD_LKP_!!!!",I})();class x extends d{constructor(y,u){super(y),this._sql=u}rewriteSql(y,u){return{rewritten:!0,where:(0,g.bB)(y,this.field.name,(0,g.zR)(this._sql,D.Bj.Standardised),u.getFieldsIndex())}}extractValue(y){return this._sql.calculateValueCompiled(y)}}class P extends G.Z{static findField(y,u){for(const m of y)if(m.name.toLowerCase()===u.toString().toLowerCase())return m;return null}constructor(y){super(y),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=[],this._extraFilter=null,this._extraFilter=y.extraFilter,this._parent=y.parentfeatureset,this._maxProcessing=30,this.adaptedFields=y.adaptedFields}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new f.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=D.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const y of this.adaptedFields)y.postInitialization(this,this._parent),this.fields.push(y.field)}_getSet(y){var u=this;return(0,p.Z)(function*(){if(null===u._wset){yield u._ensureLoaded();let m=null;return m=u._extraFilter?yield u._getFilteredSet("",null,null,null,y):yield u._parent?._getSet(y),u._checkCancelled(y),(0,b.O3)(m),u._wset=new M.Z(m._candidates.slice(0),m._known.slice(0),m._ordered,u._clonePageDefinition(m.pagesDefinition)),u._wset}return u._wset})()}_isInFeatureSet(y){return(0,b.s3)(this._parent)._isInFeatureSet(y)}_getFeatures(y,u,m,F){var S=this;return(0,p.Z)(function*(){const w=[];-1!==u&&void 0===S._featureCache[u]&&w.push(u);const V=S._maxQueryRate();if(!0===S._checkIfNeedToExpandKnownPage(y,V))return yield S._expandPagedSet(y,V,0,0,F),S._getFeatures(y,u,m,F);let N=0;for(let T=y._lastFetchedIndex;T<y._known.length&&(N++,N<=m&&(y._lastFetchedIndex+=1),!(void 0===S._featureCache[y._known[T]]&&(y._known[T]!==u&&w.push(y._known[T]),w.length>=V)));T++);if(0===w.length)return"success";y=new M.Z([],w,y._ordered,null);const k=Math.min(w.length,m);yield S._parent?._getFeatures(y,-1,k,F),S._checkCancelled(F);const B=[];for(let T=0;T<k;T++){const U=S._parent?._featureFromCache(w[T]);void 0!==U&&B.push({geometry:U.geometry,attributes:U.attributes,id:w[T]})}for(const T of B){const U=[];for(const W of S.adaptedFields)U[W.field.name]=W.extractValue(T);S._featureCache[T.id]=new q.Z({attributes:U,geometry:(0,Z.r1)(T.geometry)})}return"success"})()}_fetchAndRefineFeatures(){return(0,p.Z)(function*(){throw new R.EN(R.H9.NeverReach)})()}_getFilteredSet(y,u,m,F,S){var w=this;return(0,p.Z)(function*(){let V=!1;const N=w._reformulateWithoutAdaptions(m);V=N.cannot,m=N.where;let k=!1;if(null!==F){k=!0;const U=[];for(const W of w.adaptedFields)if(!(W instanceof O)&&!0===F.scanForField(W.field.name)){if(!(W instanceof o)){F=null,k=!1;break}U.push({field:W.field.name,newfield:W.originalField.name})}F&&U.length>0&&(F=F.replaceFields(U))}null!==m?null!==w._extraFilter&&(m=(0,g.$e)(w._extraFilter,m)):m=w._extraFilter,yield w._ensureLoaded();const B=yield(0,b.s3)(w._parent)._getFilteredSet(y,u,m,F,S);let T;return w._checkCancelled(S),T=!0===V?new M.Z(B._candidates.slice(0).concat(B._known.slice(0)),[],!0===k&&B._ordered,w._clonePageDefinition(B.pagesDefinition)):new M.Z(B._candidates.slice(0),B._known.slice(0),!0===k&&B._ordered,w._clonePageDefinition(B.pagesDefinition)),T})()}_reformulateWithoutAdaptions(y){const u={cannot:!1,where:y};if(null!==y)for(const m of this.adaptedFields)if(!0===(0,g.hq)(y,m.field.name)){const F=m.rewriteSql(y,this);if(!0!==F.rewritten){u.cannot=!0,u.where=null;break}u.where=F.where}return u}_stat(y,u,m,F,S,w,V){var N=this;return(0,p.Z)(function*(){let k=!1,B=N._reformulateWithoutAdaptions(u);if(k=B.cannot,u=B.where,B=N._reformulateWithoutAdaptions(S),k=k||B.cannot,null!==(S=B.where)?null!==N._extraFilter&&(S=(0,g.$e)(N._extraFilter,S)):S=N._extraFilter,!0===k)return null===S&&""===m&&null===F?N._manualStat(y,u,w,V):{calculated:!1};const T=yield(0,b.s3)(N._parent)._stat(y,u,m,F,S,w,V);return!1===T.calculated?null===S&&""===m&&null===F?N._manualStat(y,u,w,V):{calculated:!1}:T})()}_canDoAggregates(y,u,m,F,S){var w=this;return(0,p.Z)(function*(){if(null===w._parent)return!1;for(let k=0;k<y.length;k++)for(const B of w.adaptedFields)if(y[k].toLowerCase()===B.field.name.toLowerCase()&&!(B instanceof O))return!1;const V=[];for(let k=0;k<u.length;k++){const B=u[k];if(null!==B.workingexpr){const T=w._reformulateWithoutAdaptions(B.workingexpr);if(T.cannot)return!1;const U=B.clone();U.workingexpr=T.where,V.push(U)}else V.push(B)}const N=w._reformulateWithoutAdaptions(S);return!N.cannot&&(null!==(S=N.where)?null!==w._extraFilter&&(S=(0,g.$e)(w._extraFilter,S)):S=w._extraFilter,w._parent._canDoAggregates(y,V,m,F,S))})()}_getAggregatePagesDataSourceDefinition(y,u,m,F,S,w,V){var N=this;return(0,p.Z)(function*(){if(null===N._parent)throw new R.EN(R.H9.NeverReach);const k=[];for(let T=0;T<u.length;T++){const U=u[T];if(null!==U.workingexpr){const W=N._reformulateWithoutAdaptions(U.workingexpr);if(W.cannot)throw new R.EN(R.H9.NeverReach);const ae=U.clone();ae.workingexpr=W.where,k.push(ae)}else k.push(U)}const B=N._reformulateWithoutAdaptions(S);if(B.cannot)throw new R.EN(R.H9.NeverReach);return null!==(S=B.where)?null!==N._extraFilter&&(S=(0,g.$e)(N._extraFilter,S)):S=N._extraFilter,N._parent._getAggregatePagesDataSourceDefinition(y,k,m,F,S,w,V)})()}}},53997:(ie,Y,h)=>{h.d(Y,{Z:()=>b});var p=h(15861),q=h(47982),X=h(49086),Z=h(91510),R=h(77132),G=h(83947),M=h(10699),D=h(10410),g=h(65234);class b extends X.Z{constructor(f){super(f),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=f.parentfeatureset,f.whereclause instanceof D.WhereClause?(this._whereclause=f.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=f.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new g.Z({wkid:4326}),this.geometryType=R.Qk.point)}_getSet(f){var d=this;return(0,p.Z)(function*(){if(null===d._wset){yield d._ensureLoaded();const O=yield d._parent._getFilteredSet("",null,d._whereclause,null,f);return d._checkCancelled(f),d._wset=null!==d._whereClauseFunction?new Z.Z(O._candidates.slice(0).concat(O._known.slice(0)),[],O._ordered,d._clonePageDefinition(O.pagesDefinition)):new Z.Z(O._candidates.slice(0),O._known.slice(0),O._ordered,d._clonePageDefinition(O.pagesDefinition)),d._wset}return d._wset})()}_isInFeatureSet(f){let d=this._parent?._isInFeatureSet(f);return d===R.dj.NotInFeatureSet?d:(d=this._idstates[f],void 0===d?R.dj.Unknown:d)}_getFeature(f,d,O){return this._parent._getFeature(f,d,O)}_getFeatures(f,d,O,o){return this._parent._getFeatures(f,d,O,o)}_featureFromCache(f){return this._parent._featureFromCache(f)}executeWhereClause(f){return this._whereclause?.testFeature(f)??!1}executeWhereClauseDeferred(f){var d=this;return(0,p.Z)(function*(){if(null!==d._whereClauseFunction){const O=d._whereClauseFunction(f);return(0,M.y8)(O),O}return d.executeWhereClause(f)})()}_fetchAndRefineFeatures(f,d,O){var o=this;return(0,p.Z)(function*(){const v=new Z.Z([],f,!1,null),x=Math.min(d,f.length);if(yield o._parent?._getFeatures(v,-1,x,O),o._checkCancelled(O),null==o._whereClauseFunction){for(let I=0;I<x;I++){const y=o._parent?._featureFromCache(f[I]);o._idstates[f[I]]=!0===o.executeWhereClause(y)?R.dj.InFeatureSet:R.dj.NotInFeatureSet}return"success"}const P=[];for(let I=0;I<x;I++){const y=o._parent?._featureFromCache(f[I]);P.push(yield o.executeWhereClauseDeferred(y))}for(let I=0;I<d;I++)o._idstates[f[I]]=!0===P[I]?R.dj.InFeatureSet:R.dj.NotInFeatureSet;return"success"})()}_getFilteredSet(f,d,O,o,v){var x=this;return(0,p.Z)(function*(){null!==x._whereClauseFunction||(null!==O?null!==x._whereclause&&(O=(0,G.$e)(x._whereclause,O)):O=x._whereclause),yield x._ensureLoaded();const P=yield x._parent._getFilteredSet(f,d,O,o,v);let I;return x._checkCancelled(v),I=null!==x._whereClauseFunction?new Z.Z(P._candidates.slice(0).concat(P._known.slice(0)),[],P._ordered,x._clonePageDefinition(P.pagesDefinition)):new Z.Z(P._candidates.slice(0),P._known.slice(0),P._ordered,x._clonePageDefinition(P.pagesDefinition)),I})()}_stat(f,d,O,o,v,x,P){var I=this;return(0,p.Z)(function*(){if(null!==I._whereClauseFunction)return null===v&&""===O&&null===o?I._manualStat(f,d,x,P):{calculated:!1};let y=I._whereclause;null!==v&&null!==I._whereclause&&(y=(0,G.$e)(I._whereclause,v));const u=yield I._parent._stat(f,d,O,o,y,x,P);return!1===u.calculated?null===v&&""===O&&null===o?I._manualStat(f,d,x,P):{calculated:!1}:u})()}_canDoAggregates(f,d,O,o,v){var x=this;return(0,p.Z)(function*(){return null===x._whereClauseFunction&&(null!==v?null!==x._whereclause&&(v=(0,G.$e)(x._whereclause,v)):v=x._whereclause,null!==x._parent&&x._parent._canDoAggregates(f,d,O,o,v))})()}_getAggregatePagesDataSourceDefinition(f,d,O,o,v,x,P){var I=this;return(0,p.Z)(function*(){if(null===I._parent)throw new q.EN(q.H9.NeverReach);return null!==v?null!==I._whereclause&&(v=(0,G.$e)(I._whereclause,v)):v=I._whereclause,I._parent._getAggregatePagesDataSourceDefinition(f,d,O,o,v,x,P)})()}static registerAction(){X.Z._featuresetFunctions.filter=function(f){if("function"==typeof f)return new b({parentfeatureset:this,whereclause:f});let d=null;return f instanceof D.WhereClause&&(d=f),new b({parentfeatureset:this,whereclause:d})}}}},95896:(ie,Y,h)=>{h.d(Y,{Z:()=>M});var p=h(15861),q=h(47562),X=h(47982),Z=h(49086),R=h(91510),G=h(57366);class M extends Z.Z{constructor(g){super(g),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=g.orderbyclause,this._parent=g.parentfeatureset}_getSet(g){var b=this;return(0,p.Z)(function*(){if(null===b._wset){yield b._ensureLoaded();const A=yield b._getFilteredSet("",null,null,b._orderbyclause,g);return b._checkCancelled(g),b._wset=A,b._wset}return b._wset})()}manualOrderSet(g,b){var A=this;return(0,p.Z)(function*(){const f=yield A.getIdColumnDictionary(g,[],-1,b);A._orderbyclause?.order(f);const d=new R.Z([],[],!0,null);for(let O=0;O<f.length;O++)d._known.push(f[O].id);return d})()}getIdColumnDictionary(g,b,A,f){var d=this;return(0,p.Z)(function*(){if(A<g._known.length-1){const O=d._maxQueryRate();if("GETPAGES"===g._known[A+1])return yield(0,q.W)(d._parent._expandPagedSet(g,O,0,0,f)),d.getIdColumnDictionary(g,b,A,f);let o=A+1;const v=[];for(;o<g._known.length&&"GETPAGES"!==g._known[o];)v.push(g._known[o]),o++;A+=v.length;const x=yield(0,q.W)(d._parent._getFeatureBatch(v,f));d._checkCancelled(f);for(const P of x)b.push({id:P.attributes[d.objectIdField],feature:P});return d.getIdColumnDictionary(g,b,A,f)}return g._candidates.length>0?(yield(0,q.W)(d._refineSetBlock(g,d._maxProcessingRate(),f)),d._checkCancelled(f),d.getIdColumnDictionary(g,b,A,f)):b})()}_isInFeatureSet(g){return this._parent._isInFeatureSet(g)}_getFeatures(g,b,A,f){return this._parent._getFeatures(g,b,A,f)}_featureFromCache(g){if(void 0===this._featureCache[g]){const b=this._parent._featureFromCache(g);return void 0===b?void 0:null===b?null:(this._featureCache[g]=b,b)}return this._featureCache[g]}_fetchAndRefineFeatures(){return(0,p.Z)(function*(){throw new X.EN(X.H9.NeverReach)})()}_getFilteredSet(g,b,A,f,d){var O=this;return(0,p.Z)(function*(){yield O._ensureLoaded();const o=yield O._parent._getFilteredSet(g,b,A,null===f?O._orderbyclause:f,d);O._checkCancelled(d);const v=new R.Z(o._candidates.slice(0),o._known.slice(0),o._ordered,O._clonePageDefinition(o.pagesDefinition));let x=!0;if(o._candidates.length>0&&(x=!1),!1===v._ordered){let P=yield O.manualOrderSet(v,d);return!1===x&&(null===b&&null===A||(P=new R.Z(P._candidates.slice(0).concat(P._known.slice(0)),[],P._ordered,O._clonePageDefinition(P.pagesDefinition)))),P}return v})()}static registerAction(){Z.Z._featuresetFunctions.orderBy=function(g){return""===g?this:new M({parentfeatureset:this,orderbyclause:new G.Z(g)})}}}},79429:(ie,Y,h)=>{h.d(Y,{Z:()=>G});var p=h(15861),q=h(47982),X=h(49086),Z=h(91510),R=h(77132);class G extends X.Z{constructor(D){super(D),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=D.topnum,this._parent=D.parentfeatureset}_getSet(D){var g=this;return(0,p.Z)(function*(){if(null===g._wset){yield g._ensureLoaded();const b=yield g._parent._getSet(D);return g._wset=new Z.Z(b._candidates.slice(0),b._known.slice(0),!1,g._clonePageDefinition(b.pagesDefinition)),g._setKnownLength(g._wset)>g._topnum&&(g._wset._known=g._wset._known.slice(0,g._topnum)),g._setKnownLength(g._wset)>=g._topnum&&(g._wset._candidates=[]),g._wset}return g._wset})()}_setKnownLength(D){return D._known.length>0&&"GETPAGES"===D._known[D._known.length-1]?D._known.length-1:D._known.length}_isInFeatureSet(D){const g=this._parent._isInFeatureSet(D);if(g===R.dj.NotInFeatureSet)return g;const b=this._idstates[D];return b===R.dj.InFeatureSet||b===R.dj.NotInFeatureSet?b:g===R.dj.InFeatureSet&&void 0===b?this._countedin<this._topnum?(this._idstates[D]=R.dj.InFeatureSet,this._countedin++,R.dj.InFeatureSet):(this._idstates[D]=R.dj.NotInFeatureSet,R.dj.NotInFeatureSet):R.dj.Unknown}_expandPagedSet(D,g,b,A,f){var d=this;return(0,p.Z)(function*(){if(null===d._parent)throw new q.EN(q.H9.NotImplemented);if(g>d._topnum&&(g=d._topnum),d._countedin>=d._topnum&&D.pagesDefinition.internal.set.length<=D.pagesDefinition.resultOffset){let o=D._known.length;return o>0&&"GETPAGES"===D._known[o-1]&&(D._known.length=o-1),o=D._candidates.length,o>0&&"GETPAGES"===D._candidates[o-1]&&(D._candidates.length=o-1),"success"}const O=yield d._parent._expandPagedSet(D,g,b,A,f);return d._setKnownLength(D)>d._topnum&&(D._known.length=d._topnum),d._setKnownLength(D)>=d._topnum&&(D._candidates.length=0),O})()}_getFeatures(D,g,b,A){var f=this;return(0,p.Z)(function*(){const d=[],O=f._maxQueryRate();if(!0===f._checkIfNeedToExpandKnownPage(D,O))return yield f._expandPagedSet(D,O,0,0,A),f._getFeatures(D,g,b,A);-1!==g&&void 0===f._featureCache[g]&&d.push(g);let o=0;for(let P=D._lastFetchedIndex;P<D._known.length&&(o++,o<=b&&(D._lastFetchedIndex+=1),!(void 0===f._featureCache[D._known[P]]&&(D._known[P]!==g&&d.push(D._known[P]),d.length>O)));P++);if(0===d.length)return"success";const v=new Z.Z([],d,!1,null),x=Math.min(d.length,b);yield f._parent._getFeatures(v,-1,x,A);for(let P=0;P<x;P++){const I=f._parent._featureFromCache(d[P]);void 0!==I&&(f._featureCache[d[P]]=I)}return"success"})()}_getFilteredSet(D,g,b,A,f){var d=this;return(0,p.Z)(function*(){yield d._ensureLoaded();const O=yield d._getSet(f);return new Z.Z(O._candidates.slice(0).concat(O._known.slice(0)),[],!1,d._clonePageDefinition(O.pagesDefinition))})()}_refineKnowns(D,g){let b=0,A=null;const f=[];for(let d=0;d<D._candidates.length;d++){const O=this._isInFeatureSet(D._candidates[d]);if(O===R.dj.InFeatureSet){if(D._known.push(D._candidates[d]),b+=1,null===A?A={start:d,end:d}:A.end===d-1?A.end=d:(f.push(A),A={start:d,end:d}),D._known.length>=this._topnum)break}else if(O===R.dj.NotInFeatureSet)null===A?A={start:d,end:d}:A.end===d-1?A.end=d:(f.push(A),A={start:d,end:d}),b+=1;else if(O===R.dj.Unknown)break;if(b>=g)break}null!==A&&f.push(A);for(let d=f.length-1;d>=0;d--)D._candidates.splice(f[d].start,f[d].end-f[d].start+1);this._setKnownLength(D)>this._topnum&&(D._known=D._known.slice(0,this._topnum)),this._setKnownLength(D)>=this._topnum&&(D._candidates=[])}_stat(){return(0,p.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,p.Z)(function*(){return!1})()}static registerAction(){X.Z._featuresetFunctions.top=function(D){return new G({parentfeatureset:this,topnum:D})}}}},16776:(ie,Y,h)=>{h.d(Y,{Z:()=>d});var p=h(15861),q=h(88879),X=h(47982),Z=h(49086),R=h(91510),G=h(77132),M=h(83947),D=h(21674),g=h(80415),b=h(41638),A=h(36255),f=h(96854);class d extends Z.Z{constructor(o){super(o),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,o.spatialReference&&(this.spatialReference=o.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=o.layer,this._wset=null,!0===o.isTable&&(this._forceIsTable=!0),void 0!==o.outFields&&(this._overrideFields=o.outFields),void 0!==o.includeGeometry&&(this._removeGeometry=!1===o.includeGeometry)}_maxQueryRate(){return G.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var o=this;return(0,p.Z)(function*(){return!0===o._layer.loaded?(o._initialiseFeatureSet(),o):(yield o._layer.load(),o._initialiseFeatureSet(),o)})()}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const o=[];for(const v of this.fields)if("oid"===v.type)o.push(v);else for(const x of this._layer.outFields)if(x.toLowerCase()===v.name.toLowerCase()){o.push(v);break}this.fields=o}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const o=[],v=[];for(const x of this.fields)if("oid"===x.type)o.push(x),v.push(x.name);else for(const P of this._overrideFields)if(P.toLowerCase()===x.name.toLowerCase()){o.push(x),v.push(x.name);break}this.fields=o,this._overrideFields=v}this.objectIdField=this._layer.objectIdField;for(const o of this.fields)"global-id"===o.type&&(this.globalIdField=o.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=G.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return G.dj.InFeatureSet}_candidateIdTransform(o){return o}_getSet(o){var v=this;return(0,p.Z)(function*(){if(null===v._wset){yield v._ensureLoaded();const x=yield v._getFilteredSet("",null,null,null,o);return v._wset=x,x}return v._wset})()}_changeFeature(o){const v={};for(const x of this.fields)v[x.name]=o.attributes[x.name];return new q.Z({geometry:!0===this._removeGeometry?null:o.geometry,attributes:v})}_getFilteredSet(o,v,x,P,I){var y=this;return(0,p.Z)(function*(){let u="",m=!1;if(null!==P&&(u=P.constructClause(),m=!0),y.isTable()&&v&&null!==o&&""!==o)return new R.Z([],[],!0,null);const F=new f.Z;F.where=null===x?null===v?"1=1":"":(0,M.zR)(x,G.Bj.Standardised),F.spatialRelationship=y._makeRelationshipEnum(o),F.outSpatialReference=y.spatialReference,F.orderByFields=""!==u?u.split(","):null,F.geometry=null===v?null:v,F.returnGeometry=!0,F.relationParameter=y._makeRelationshipParam(o);const S=yield y._layer.queryFeatures(F);if(null===S)return new R.Z([],[],m,null);y._checkCancelled(I);const w=[];return S.features.forEach(V=>{const N=V.attributes[y._layer.objectIdField];w.push(N),y._featureCache[N]=y._changeFeature(V)}),new R.Z([],w,m,null)})()}_makeRelationshipEnum(o){if(o.includes("esriSpatialRelRelation"))return"relation";switch(o){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return o}_makeRelationshipParam(o){return o.includes("esriSpatialRelRelation")?o.split(":")[1]:""}_queryAllFeatures(){var o=this;return(0,p.Z)(function*(){if(o._wset)return o._wset;const v=new f.Z;if(v.where="1=1",yield o._ensureLoaded(),o._layer.source&&o._layer.source.items){const I=[];return o._layer.source.items.forEach(y=>{const u=y.attributes[o._layer.objectIdField];I.push(u),o._featureCache[u]=o._changeFeature(y)}),o._wset=new R.Z([],I,!1,null),o._wset}const x=yield o._layer.queryFeatures(v),P=[];return x.features.forEach(I=>{const y=I.attributes[o._layer.objectIdField];P.push(y),o._featureCache[y]=o._changeFeature(I)}),o._wset=new R.Z([],P,!1,null),o._wset})()}_getFeatures(o,v,x){var P=this;return(0,p.Z)(function*(){const I=[];-1!==v&&void 0===P._featureCache[v]&&I.push(v);for(let y=o._lastFetchedIndex;y<o._known.length&&(o._lastFetchedIndex+=1,!(void 0===P._featureCache[o._known[y]]&&(o._known[y]!==v&&I.push(o._known[y]),I.length>x)));y++);if(0===I.length)return"success";throw new X.EN(X.H9.MissingFeatures)})()}_refineSetBlock(o){return(0,p.Z)(function*(){return o})()}_stat(){return(0,p.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,p.Z)(function*(){return!1})()}relationshipMetaData(){return[]}static _cloneAttr(o){const v={};for(const x in o)v[x]=o[x];return v}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(o,v){let x=o.layerDefinition.objectIdField;const P=o.layerDefinition.typeIdField?o.layerDefinition.typeIdField:"",I=[];if(o.layerDefinition.types)for(const N of o.layerDefinition.types)I.push(b.Z.fromJSON(N));let y=o.layerDefinition.geometryType;void 0===y&&(y=o.featureSet.geometryType||"");let u=o.featureSet.features;const m=v.toJSON();if(""===x||void 0===x){let N=!1;for(const k of o.layerDefinition.fields)if("oid"===k.type||"esriFieldTypeOID"===k.type){x=k.name,N=!0;break}if(!1===N){let k="FID",B=!0,T=0;for(;B;){let W=!0;for(const ae of o.layerDefinition.fields)if(ae.name===k){W=!1;break}!0===W?B=!1:(T++,k="FID"+T.toString())}o.layerDefinition.fields.push({type:"esriFieldTypeOID",name:k,alias:k});const U=[];for(let W=0;W<u.length;W++)U.push({geometry:o.featureSet.features[W].geometry,attributes:o.featureSet.features[W].attributes?this._cloneAttr(o.featureSet.features[W].attributes):{}}),U[W].attributes[k]=W;u=U,x=k}}const F=[];for(const N of o.layerDefinition.fields)F.push(N instanceof A.Z?N:A.Z.fromJSON(N));let S=y;switch(S||(S=""),S){case"esriGeometryPoint":S="point";break;case"esriGeometryPolyline":S="polyline";break;case"esriGeometryPolygon":S="polygon";break;case"esriGeometryExtent":S="extent";break;case"esriGeometryMultipoint":S="multipoint";break;case"":case"esriGeometryNull":S="esriGeometryNull"}if("esriGeometryNull"!==S)for(const N of u)N.geometry&&!(N.geometry instanceof D.Z)&&(N.geometry.type=S,void 0===N.geometry.spatialReference&&(N.geometry.spatialReference=m));else for(const N of u)N.geometry&&(N.geometry=null);const w={outFields:["*"],source:u,fields:F,types:I,typeIdField:P,objectIdField:x,spatialReference:v};""!==S&&"esriGeometryNull"!==S&&null!==S&&(w.geometryType=S);const V=new g.default(w);return new d({layer:V,spatialReference:v,isTable:null===S||""===S||"esriGeometryNull"===S})}queryAttachments(){return(0,p.Z)(function*(){return[]})()}getFeatureByObjectId(o){var v=this;return(0,p.Z)(function*(){const x=new f.Z;x.where=v.objectIdField+"="+o.toString();const P=yield v._layer.queryFeatures(x);return 1===P.features.length?P.features[0]:null})()}getOwningSystemUrl(){return(0,p.Z)(function*(){return""})()}getIdentityUser(){return(0,p.Z)(function*(){return""})()}get preferredTimeReference(){return this._layer?.preferredTimeReference?.toJSON()??null}get dateFieldsTimeReference(){return this._layer?.dateFieldsTimeReference?.toJSON()??null}get datesInUnknownTimezone(){return this._layer?.datesInUnknownTimezone}get editFieldsInfo(){return this._layer?.editFieldsInfo?.toJSON()??null}get timeInfo(){return this._layer?.timeInfo?.toJSON()??null}}},57366:(ie,Y,h)=>{function p(X,Z){return X===Z?0:null===X?-1:null===Z?1:X<Z?-1:1}h.d(Y,{Z:()=>q});class q{constructor(Z){const R=Z.split(",");this._fields=[],this._directions=[];for(let G=0;G<R.length;G++){const M=R[G].match(/\S+/g);this._fields.push(M[0]),2===M.length?"asc"===M[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let Z="";for(let R=0;R<this._fields.length;R++)0!==R&&(Z+=","),Z+=this._fields[R],Z+=1===this._directions[R]?" ASC":" DESC";return Z}order(Z){Z.sort((R,G)=>{for(let M=0;M<this._fields.length;M++){const D=this.featureValue(R.feature,this._fields[M],M),g=this.featureValue(G.feature,this._fields[M],M);let b=0;if(b=1===this._directions[M]?p(D,g):-1*p(D,g),0!==b)return b}return 0})}scanForField(Z){for(let R=0;R<this._fields.length;R++)if(this._fields[R].toLowerCase().trim()===Z.toLowerCase().trim())return!0;return!1}replaceFields(Z){let R="";for(let G=0;G<this._fields.length;G++){0!==G&&(R+=",");let M=this._fields[G];for(const D of Z)if(M.toLowerCase()===D.field.toLowerCase()){M=D.newfield;break}R+=M,R+=1===this._directions[G]?" ASC":" DESC"}return new q(R)}featureValue(Z,R,G){const M=Z.attributes[R];if(void 0!==M)return M;for(const D in Z.attributes)if(R.toLowerCase()===D.toLowerCase())return this._fields[G]=D,Z.attributes[D];return null}}}}]);